# é¹¦é¹‰èºå¼•æ“ (NautilusTrader) Ã— IBKR å®ç›˜äº¤æ˜“ç³»ç»Ÿ

> ä¸ªäººé‡åŒ–äº¤æ˜“åŸºç¡€è®¾æ–½ â€”â€” ç”¨å·¥ä¸šçº§æ¡†æ¶ï¼Œæå°‘é‡ä»£ç ï¼Œæ­å»ºç”Ÿäº§å¯ç”¨çš„å®ç›˜ç³»ç»Ÿã€‚

åŸºäº **NautilusTrader** æ¡†æ¶è¿æ¥ **Interactive Brokers (IBKR)**ï¼Œæ”¯æŒå¤šæ ‡çš„å®æ—¶ K çº¿ã€SuperTrend æŒ‡æ ‡è®¡ç®—ã€HTTP ä¸‹å•ç½‘å…³å’Œå‰ç«¯å¯è§†åŒ– Dashboardã€‚

---

## é¡¹ç›®ç›®æ ‡

æœ¬é¡¹ç›®çš„ç›®æ ‡ä¸æ˜¯å®ç°æŸä¸€ä¸ªå…·ä½“çš„äº¤æ˜“ç­–ç•¥ï¼Œè€Œæ˜¯æ­å»ºä¸€å¥—**å®Œæ•´ã€ç¨³å®šã€å¯æ‰©å±•çš„ä¸ªäººé‡åŒ–åŸºç¡€è®¾æ–½**ï¼š

1. **æ•°æ®å±‚**ï¼šä» IBKR è·å–å®æ—¶å’Œå†å² K çº¿ï¼Œç»è¿‡è®¡ç®—åå­˜å…¥ Redisï¼Œä¾›ä¸Šå±‚éšæ—¶æ¶ˆè´¹
2. **ä¿¡å·å±‚**ï¼šåœ¨å¼•æ“å†…è®¡ç®— SuperTrendã€EMAã€æ—¥å†…æ–°é«˜ç­‰æŠ€æœ¯æŒ‡æ ‡ï¼Œä½œä¸ºäº¤æ˜“ä¾æ®
3. **æ‰§è¡Œå±‚**ï¼šé€šè¿‡ NautilusTrader å†…ç½®çš„é£é™©å¼•æ“å’Œè®¢å•ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿ä¸‹å•å‡†ç¡®å¯é 
4. **å±•ç¤ºå±‚**ï¼šå‰ç«¯å®æ—¶å¯è§†åŒ– K çº¿ã€æŒ‡æ ‡ç§¯åˆ†ã€ä»“ä½ç›ˆäºã€è¯­éŸ³æé†’ï¼Œè¾…åŠ©äººå·¥å†³ç­–

è¿™æ˜¯ä¸€å¥—**åŠè‡ªåŠ¨**çš„ç³»ç»Ÿâ€”â€”å¼•æ“è´Ÿè´£æ•°æ®å’Œæ‰§è¡Œï¼Œäººå·¥è´Ÿè´£ä¿¡å·åˆ¤æ–­å’Œæœ€ç»ˆå†³ç­–ã€‚

---

## è®¾è®¡åŸåˆ™

| åŸåˆ™ | å®ç°æ–¹å¼ |
|------|---------|
| **èŒè´£åˆ†ç¦»** | å¼•æ“åªè®¡ç®—ï¼ŒRedis åªä¼ é€’ï¼Œå‰ç«¯åªå±•ç¤ºï¼Œä¸‰å±‚å®Œå…¨è§£è€¦ |
| **ç‹¬ç«‹é‡å¯** | ä»»æ„ä¸€å±‚é‡å¯ï¼Œå…¶ä½™å±‚ä¸å—å½±å“ï¼ŒRedis æ˜¯å”¯ä¸€å…±äº«çŠ¶æ€ |
| **æ•°æ®æº¯æº** | å…¨éƒ¨æ•°æ®æ¥è‡ª IBKRï¼Œæ— å¤–éƒ¨æ•°æ®æºä¾èµ–ï¼Œå›æµ‹ä¸å®ç›˜ä½¿ç”¨åŒä¸€å¥—ä»£ç  |
| **å°‘å†™ä»£ç ** | å……åˆ†åˆ©ç”¨ NautilusTrader çš„è®¢å•ç®¡ç†ã€é£æ§ã€äº‹ä»¶é©±åŠ¨èƒ½åŠ›ï¼Œä¸“æ³¨ alpha é€»è¾‘ |
| **å¯æ‰©å±•** | æ ‡çš„æ•°é‡ã€æŒ‡æ ‡ç§ç±»ã€å‰ç«¯å±•ç¤ºå‡å¯ç‹¬ç«‹æ‰©å±•ï¼Œäº’ä¸å½±å“ |

---

## æ¶æ„è¯„ä»·

> **NautilusTrader çš„æ ¸å¿ƒä»·å€¼**ï¼šä»¥ Rust ä¸ºæ ¸å¿ƒçš„é«˜æ€§èƒ½äº‹ä»¶é©±åŠ¨å¼•æ“ï¼Œå¼€ç®±å³å¾—ä»¥ä¸‹å·¥ä¸šçº§èƒ½åŠ›â€”â€”

| å¼•æ“å†…ç½®èƒ½åŠ› | è‹¥è‡ªè¡Œå®ç°éœ€è¦çš„ä»£ç é‡ |
|------------|------------------|
| å®Œæ•´è®¢å•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœºï¼ˆACCEPTED/FILLED/REJECTED ç­‰ï¼‰ | ~500 è¡Œ |
| é£é™©å¼•æ“ï¼ˆä»“ä½é™åˆ¶ã€èµ„é‡‘æ ¡éªŒï¼‰ | ~300 è¡Œ |
| OCA è”åŠ¨è®¢å•ï¼ˆæ­¢æŸè§¦å‘è‡ªåŠ¨å–æ¶ˆå…³è”å•ï¼‰ | ~200 è¡Œ |
| IBKR åè®®é€‚é…ï¼ˆåˆçº¦æŸ¥è¯¢ã€è¿æ¥é‡è¯•ï¼‰ | ~1000 è¡Œ |
| å›æµ‹/å®ç›˜é€šç”¨æ¥å£ | ~800 è¡Œ |
| çº³ç§’çº§æ—¶é—´æˆ³å¯¹é½ã€å¤šæ ‡çš„äº‹ä»¶æ’åº | ~300 è¡Œ |

**æœ¬é¡¹ç›®å®é™…ç¼–å†™çš„æ ¸å¿ƒä»£ç **ï¼š`strategy.py` ~530 è¡Œ + `order_actor.py` ~220 è¡Œï¼Œå´è·å¾—äº† 3000+ è¡Œæ‰èƒ½å®ç°çš„å·¥ä¸šçº§å¯é æ€§ã€‚

**ä¸ªäººé‡åŒ–è€…è§†è§’**ï¼šè¿™å¥—æ¶æ„å·²è¶…è¿‡å¤§å¤šæ•°ä¸ªäººé‡åŒ–åŸºç¡€è®¾æ–½çš„æˆç†Ÿåº¦ï¼Œå…·å¤‡çœŸæ­£çš„ç”Ÿäº§éƒ¨ç½²èƒ½åŠ›ï¼š
- âœ… è§£è€¦ã€äº‹ä»¶é©±åŠ¨ã€çŠ¶æ€åˆ†ç¦»
- âœ… å®æ—¶æŒ‡æ ‡è®¡ç®— + è¯­éŸ³æé†’ + å¯è§†åŒ– Dashboard
- âœ… å®Œæ•´è®¢å•é“¾è·¯ï¼ˆä¸‹å• â†’ æˆäº¤ â†’ ä»“ä½æ›´æ–° â†’ æ­¢æŸç®¡ç†ï¼‰
- âš ï¸ ä¸‹ä¸€æ­¥ï¼šRedis å‘Šè­¦ + ä¿¡å·è‡ªåŠ¨åŒ– + ç­–ç•¥å½’æ¡£

---

## é¡¹ç›®ç»“æ„

```
nautilus_ibkr_helloworld/
â”œâ”€â”€ main.py            # ä¸»ç¨‹åºï¼šé…ç½®å¹¶å¯åŠ¨ TradingNodeï¼ˆæ”¯æŒ --mode live/backtestï¼‰
â”œâ”€â”€ strategy.py        # å›æµ‹/å®ç›˜é€šç”¨ç­–ç•¥ï¼š1m K çº¿ + SuperTrend + EMA + æ—¥Kå›´æ  + å†™Redis
â”œâ”€â”€ order_actor.py     # HTTP ä¸‹å•ç½‘å…³ Actorï¼ˆç«¯å£ 8888ï¼‰+ è®¢å•çŠ¶æ€ Redis å›è°ƒ
â”œâ”€â”€ order_sender.py    # å¤–éƒ¨ä¸‹å•æµ‹è¯•è„šæœ¬ï¼ˆMARKET / BRACKETï¼‰
â””â”€â”€ frontend/
    â”œâ”€â”€ server.js      # Node.js WebSocket æœåŠ¡å™¨ï¼Œä» Redis æ¨é€ K çº¿ + æŒ‡æ ‡ç»™å‰ç«¯
    â””â”€â”€ public/
        â”œâ”€â”€ index.html      # å•å›¾ Dashboardï¼ˆå·¦Kçº¿ + å³æŒ‡æ ‡é¢æ¿ + è¯­éŸ³æé†’ï¼‰
        â”œâ”€â”€ multi.html      # å››å›¾æ€»è§ˆï¼ˆ2Ã—2 ç½‘æ ¼ï¼Œè¯­éŸ³æé†’ï¼‰
        â””â”€â”€ indicators.html # å››åˆ—æŒ‡æ ‡æ’è¡Œï¼ˆM1 ST / M5 ST / EMAåç¦» / æ—¥å†…æ–°é«˜ï¼‰
```

## æ¶æ„è®¾è®¡

![ç³»ç»Ÿæ¶æ„å›¾](docs/architecture.png)

**ä¸‰æ¡æ ¸å¿ƒæ•°æ®é“¾è·¯ï¼š**

| é“¾è·¯ | è·¯å¾„ | è§¦å‘æ—¶æœº |
|------|------|---------|
| å®æ—¶Kçº¿ | IBKR â†’ strategy.py â†’ Redis PUBLISH â†’ server.js â†’ WebSocket â†’ æµè§ˆå™¨ | æ¯åˆ†é’ŸKçº¿æ”¶ç›˜ |
| æŒ‡æ ‡è½®è¯¢ | æµè§ˆå™¨ â†’ HTTP GET /api/* â†’ server.js â†’ Redis GET | æ¯30ç§’ |
| è®¢å•çŠ¶æ€ | æµè§ˆå™¨ä¸‹å• â†’ order_actor.py â†’ IBKR â†’ Redis PUBLISH â†’ WebSocket â†’ è¯­éŸ³/Toast | æ¯æ¬¡è®¢å•å›æŠ¥ |
| è´¦æˆ·ä½™é¢ | IBKR reqAccountSummary â†’ AccountState äº‹ä»¶ â†’ strategy.py â†’ Redis â†’ WebSocket â†’ å·¥å…·æ  | çº¦æ¯3åˆ†é’Ÿ |

> Redis æ˜¯ä¸‰å±‚ä¹‹é—´å”¯ä¸€çš„å…±äº«çŠ¶æ€ï¼Œå¼•æ“ / server.js / æµè§ˆå™¨ä¸‰è€…å¯ç‹¬ç«‹é‡å¯ï¼Œäº’ä¸å½±å“ã€‚

## ä¾èµ–

### Python
```bash
pip install uv
uv pip install "nautilus_trader[ib]" redis
```

### Node.jsï¼ˆå‰ç«¯ï¼‰
```bash
cd frontend && npm install
```

### Redis
```bash
# macOS
brew install redis && brew services start redis

# æˆ– Docker
docker run -d -p 6379:6379 redis
```

## ç¯å¢ƒå‡†å¤‡

### 1. å¯åŠ¨ TWS æˆ– IB Gateway

- ç™»å½• [TWS](https://www.interactivebrokers.com/en/trading/tws.php) æˆ– IB Gateway
- å¼€å¯ API è¿æ¥ï¼š`Edit â†’ Global Configuration â†’ API â†’ Settings â†’ Enable ActiveX and Socket Clients`

| ç±»å‹       | ç«¯å£ï¼ˆå®ç›˜ï¼‰ | ç«¯å£ï¼ˆæ¨¡æ‹Ÿï¼‰ |
|------------|------------|------------|
| TWS        | `7496`     | `7497`     |
| IB Gateway | `4001`     | `4002`     |

### 2. ä¿®æ”¹é…ç½®

ç¼–è¾‘ `main.py` ä¸­çš„ç”¨æˆ·é…ç½®åŒºï¼š

```python
IBG_PORT      = 7496           # TWS/Gateway ç«¯å£
ACCOUNT_ID    = "F10251881"    # FA ä¸»è´¦å· ID
FA_GROUP      = "dt_test"      # FA Group åç§°ï¼ˆç•™ç©ºåˆ™ä¸ä½¿ç”¨ FA åˆ†é…ï¼‰
FA_METHOD     = "NetLiq"       # FA åˆ†é…æ–¹å¼
history_days  = 2              # åŠ è½½ 2 å¤©å†å²æ•°æ®ï¼ˆå«æ˜¨æ—¥ï¼Œä¾›å›´æ ä»·æ ¼çº¿ä½¿ç”¨ï¼‰
```

## å¯åŠ¨é¡ºåº

```bash
# Step 1ï¼šå¯åŠ¨äº¤æ˜“å¼•æ“
python main.py                          # å®ç›˜ï¼ˆä»Šæ—¥ + æ˜¨æ—¥æ•°æ® + å®æ—¶ï¼‰
python main.py --mode backtest          # å›æµ‹ï¼ˆä¸Šä¸€äº¤æ˜“æ—¥æ•°æ®ï¼‰
python main.py --mode backtest --date 2026-02-25  # å›æµ‹æŒ‡å®šæ—¥æœŸ

# Step 2ï¼šå¯åŠ¨å‰ç«¯ WebSocket æœåŠ¡å™¨
cd frontend && node server.js

# æ‰“å¼€æµè§ˆå™¨
# å•å›¾ï¼š    http://localhost:3000/?symbol=QQQ
# æŒ‡æ ‡æ’è¡Œï¼šhttp://localhost:3000/indicators.html
# å››å›¾æ€»è§ˆï¼šhttp://localhost:3000/multi.html
```

> **æ¨¡å¼å¯¹æ¯”**
> | é¡¹ç›® | å®ç›˜ï¼ˆliveï¼‰ | å›æµ‹ï¼ˆbacktestï¼‰ |
> |------|------|------|
> | IBKR è¿æ¥ | âœ… å¿…é¡» | âœ… å¿…é¡» |
> | æ•°æ®æ¥æº | ä»Šæ—¥+æ˜¨æ—¥ IBKR å†å² K çº¿ | IBKR ä¸Šä¸€äº¤æ˜“æ—¥æ•°æ® |
> | å®æ—¶ Bar è®¢é˜… | âœ… | âŒ |
> | Tick è®¢é˜… | âœ… | âŒ |
> | Redis å†™å…¥ | âœ… | âœ… |

## å‰ç«¯ UI åŠŸèƒ½

### å•å›¾æ¨¡å¼ï¼ˆindex.htmlï¼‰

å·¦å³åˆ†æ å¸ƒå±€ï¼š
- **å·¦ä¾§ 70%**ï¼šK çº¿å›¾ï¼ˆSuperTrend åˆ†æ®µå½©è‰²çº¿ã€EMA21ã€å¼€ç›˜åŒºé—´ OR High/Lowï¼‰
- **å³ä¾§ 30%**ï¼šå››ä¸ªå¯æŠ˜å æŒ‡æ ‡é¢æ¿ï¼ˆç‚¹å‡»æ ‡é¢˜æ å±•å¼€/æ”¶èµ·ï¼‰

**ä»·æ ¼å›´æ çº¿**ï¼ˆè‡ªåŠ¨ä»å†å²æ•°æ®è®¡ç®—ï¼‰ï¼š

| çº¿æ¡ | é¢œè‰² | å«ä¹‰ |
|------|------|------|
| OR High / OR Low | æ©™è‰²è™šçº¿ | ä»Šæ—¥å¼€ç›˜åŒºé—´ï¼ˆå‰15åˆ†é’Ÿï¼‰ |
| PDH | ğŸŸ¢ ç»¿è‰²ç‚¹çº¿ 2px | æ˜¨æ—¥æœ€é«˜ä»· |
| PDL | ğŸ”´ çº¢è‰²ç‚¹çº¿ 2px | æ˜¨æ—¥æœ€ä½ä»· |
| PDC | â¬œ ç°ç™½ç‚¹çº¿ 2px | æ˜¨æ—¥æ”¶ç›˜ä»· |

**è®¢å•ç”Ÿå‘½å‘¨æœŸæ ‡è®°**ï¼š

| æ ‡è®° | å¤–è§‚ | è§¦å‘æ—¶æœº |
|------|------|---------|
| å¼€å¤š/å¼€ç©º | è“/çº¢è‰² â†‘â†“ ç®­å¤´ | `order:update` FILLED |
| æ­¢æŸè§¦å‘ | é»„è‰² â— åœ†ç‚¹ | `order:update` TRIGGERED |
| å¹³ä»“ | æ©™è‰² â— åœ†ç‚¹ | `position:update` closed |

> æ ‡è®°ç”¨ `orderMarkers` å…¨é‡æ•°ç»„ç»Ÿä¸€ç®¡ç†ï¼Œè‡ªåŠ¨å‡åºåˆ·æ–°ï¼Œç¬¦åˆ LightweightCharts API è¦æ±‚ã€‚

### å››å›¾æ€»è§ˆï¼ˆmulti.htmlï¼‰

2Ã—2 ç½‘æ ¼åŒæ—¶æ˜¾ç¤ºå››ä¸ªæ ‡çš„å®æ—¶ K çº¿å›¾ï¼š

- **æ—¶é—´è½´è”åŠ¨**ï¼šæ‹–åŠ¨/ç¼©æ”¾ä»»æ„ä¸€å¼ å›¾ï¼Œå…¶ä½™ä¸‰å¼ åŒæ­¥å¯è§æ—¶é—´èŒƒå›´
- **åå­—çº¿è”åŠ¨**ï¼šæ‚¬åœä»»æ„ä¸€å¼ ï¼Œå…¶ä½™ä¸‰å¼ åŒæ­¥åå­—çº¿ï¼ˆ`setCrosshairPosition`ï¼‰
- **è®¢å•æ ‡è®°**ï¼šæ¯ä¸ªæ ‡çš„ç‹¬ç«‹è®°å½•å®Œæ•´è®¢å•ç”Ÿå‘½å‘¨æœŸ

### æŒ‡æ ‡é¢æ¿ï¼ˆå³ä¾§ï¼Œå•å›¾ + indicators.html å››åˆ—æ’è¡Œï¼‰


| é¢æ¿ | ç§¯åˆ†è§„åˆ™ |
|------|---------|
| M1 SuperTrend ç§¯åˆ† | è¿ç»­åŒå‘ +1/æ£’ï¼Œåšå¤šæ­£æ•°åšç©ºè´Ÿæ•° |
| M5 SuperTrend ç§¯åˆ† | åŒä¸Šï¼ŒåŸºäº5åˆ†é’ŸKçº¿ |
| EMA åç¦»ç§¯åˆ† | (M5æ”¶ç›˜ âˆ’ EMA21) Ã· ATRâ‚â‚€ |
| æ—¥å†…è¿ç»­æ–°é«˜ | 5mæ”¶ç›˜åˆ›å½“æ—¥æ–°é«˜ +1ï¼Œè·Œç ´æ¸…é›¶ |

### è¯­éŸ³æé†’

- é»˜è®¤å¼€å¯ï¼ˆå³ä¸Šè§’ `ğŸ”” è¯­éŸ³ ON` æŒ‰é’®å¯å…³é—­ï¼‰
- è§¦å‘åœºæ™¯ï¼šè®¢å•æ¥å—/æˆäº¤/æ‹’ç»/é£æ§æ‹’ç»/æ­¢æŸè§¦å‘ã€æ—¥å†…æ–°é«˜ï¼ˆé¦–æ¬¡åˆ›æ–°é«˜/è¿ç»­Næ¬¡ï¼‰

| æ–°é«˜æ¬¡æ•° | è¯­éŸ³ |
|---------|------|
| 1æ¬¡ | `QQQ åˆ›æ—¥å†…æ–°é«˜` |
| 2-3æ¬¡ | `QQQ è¿ç»­2æ¬¡æ–°é«˜` |
| 4æ¬¡ä»¥ä¸Š | `QQQ å¼ºåŠ¿ï¼è¿ç»­5æ¬¡æ–°é«˜` |

### æ­¢æŸæ‹–åŠ¨å¼€ä»“ï¼ˆå•å›¾ & å››å›¾ï¼‰

ç‚¹å‡» **ã€Œå¼€ä»“ã€** æŒ‰é’®åï¼š

1. æ­¢æŸè¯ä¸¸æ§ä»¶å‡ºç°ï¼ˆçº¢è‰²åœ†è§’æ ‡ç­¾ï¼Œå¸¦è„‰å†²åŠ¨ç”»ï¼‰
2. ä¸Šä¸‹æ‹–åŠ¨è°ƒæ•´æ­¢æŸä»·
3. è®¢å•é¢æ¿åŒæ­¥æ˜¾ç¤ºï¼šæœ€å¤§äºæŸã€å»ºè®®è‚¡æ•°ã€æ¯è‚¡é£é™©ã€å¼€ä»“é‡‘é¢ã€èµ„é‡‘å æ¯”
4. ç‚¹å‡» **ç¡®è®¤åšå¤š/åšç©º** å‘é€å¼€ä»“è¯·æ±‚

## å‘é€æµ‹è¯•è®¢å•

```bash
python order_sender.py          # å¸‚ä»·å•
python order_sender.py --bracket  # æ‹¬å·å•ï¼ˆå¸‚ä»· + æ­¢æŸ + å®šæ—¶ç§»åŠ¨æ­¢æŸï¼‰
```

## æ”¯æŒçš„è®¢å•ç±»å‹

| ç±»å‹      | è¯´æ˜ |
|-----------|------|
| `MARKET`  | å¸‚ä»·å•ï¼ˆDAYï¼‰ |
| `LIMIT`   | é™ä»·å•ï¼ˆGTCï¼‰ |
| `BRACKET` | æ‹¬å·å•ï¼šå¸‚ä»·å…¥åœº + æ­¢æŸå•ï¼ˆOCA è”åŠ¨ï¼‰ï¼Œæ”¯æŒå®šæ—¶ç§»åŠ¨æ­¢æŸ |

## Redis Key çº¦å®š

| Key                      | ç”¨é€” |
|--------------------------|------|
| `bars:1m:{SYMBOL}`       | 1m K çº¿åˆ—è¡¨ï¼ˆå« SuperTrendã€EMA21ï¼‰ |
| `bars:5m:{SYMBOL}`       | 5m èšåˆ K çº¿ï¼ˆå« nh_score æ—¥å†…æ–°é«˜è®¡æ•°ï¼‰ |
| `position:{SYMBOL}`      | ä»“ä½ä¿¡æ¯ |
| `settings:{SYMBOL}`      | ç­–ç•¥å¼€å…³ |
| `prev_day:{SYMBOL}`      | æ˜¨æ—¥å›´æ  `{high, low, close}`ï¼ˆå¼•æ“å¯åŠ¨æ—¶ç”±æ—¥Kå†™å…¥ï¼‰ |
| `account:funds`          | è´¦æˆ·èµ„é‡‘å¿«ç…§ `{account_id, balances:[{currency,total,free,locked}], ts}` |
| `kline:1m:{SYMBOL}`      | PUBLISHï¼š1m K çº¿æ”¶ç›˜äº‹ä»¶ |
| `kline:5m:{SYMBOL}`      | PUBLISHï¼š5m K çº¿æ”¶ç›˜äº‹ä»¶ï¼ˆå« nh_scoreï¼‰ |
| `kline:1m:tick:{SYMBOL}` | PUBLISHï¼šTick å®æ—¶æ›´æ–° |
| `order:update`           | PUBLISHï¼šè®¢å•çŠ¶æ€å˜æ›´ï¼ˆè¯­éŸ³/Toast ç”¨ï¼‰ |
| `account:update`         | PUBLISHï¼šè´¦æˆ·ä½™é¢å˜æ›´ï¼ˆå·¥å…·æ å®æ—¶åˆ·æ–°ï¼‰ |
| `nh:update`              | PUBLISHï¼ˆserver.jsâ†’å‰ç«¯ï¼‰ï¼š5m æ–°é«˜äº‹ä»¶ |

## âš ï¸ é¡¹ç›®æ ¸å¿ƒè¦æ±‚

> **å…¨éƒ¨æ•°æ®æ¥è‡ª IBKRï¼Œæ— å¤–éƒ¨æ•°æ®æºä¾èµ–ã€‚**

- å®ç›˜æ¨¡å¼ï¼šæ‹‰å–ä»Šæ—¥+æ˜¨æ—¥ç›˜å‰æ•°æ®ï¼ˆ04:00 ET èµ·ï¼‰+ è®¢é˜…å®æ—¶
- å›æµ‹æ¨¡å¼ï¼šæ‹‰å–ä¸Šä¸€äº¤æ˜“æ—¥ï¼ˆæˆ–æŒ‡å®šæ—¥æœŸï¼‰æ•°æ®ï¼Œå†™å…¥ Redis åä¸è®¢é˜…å®æ—¶
- ç›˜å‰æ•°æ®ï¼šç”¨äºæŒ‡æ ‡é¢„çƒ­ï¼Œä¸æ˜¾ç¤ºåœ¨å›¾è¡¨ä¸Š
- ç›˜åæ•°æ®ï¼šå®Œå…¨å¿½ç•¥

## æŒ‡æ ‡å‚æ•°

| æŒ‡æ ‡ | å‚æ•° |
|------|------|
| SuperTrend | period=10, multiplier=2.0 |
| EMA | period=21 |
| æ—¥å†…æ–°é«˜ | 5m æ”¶ç›˜ä»·é€æ­¥åˆ›å½“æ—¥æ–°é«˜ï¼Œè·Œç ´æ¸…é›¶ |

## FA Group é…ç½®

```python
FA_GROUP  = "dt_test"   # FA Group åç§°
FA_METHOD = "NetLiq"    # åˆ†é…æ–¹å¼ï¼ˆNetLiq / EqualQuantity / AvailableEquityï¼‰
```

ç•™ç©º `FA_GROUP` åˆ™ç›´æ¥åœ¨å•è´¦å·ä¸‹å•ã€‚

## å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|--------|
| `Connection refused` | æ£€æŸ¥ TWS/Gateway æ˜¯å¦å·²å¯åŠ¨ï¼ŒAPI æ˜¯å¦å·²å¼€å¯ |
| æ— å®æ—¶æ•°æ® | å°† `MARKET_DATA_TYPE` æ”¹ä¸º `IBMarketDataTypeEnum.DELAYED_FROZEN` |
| æ˜¨æ—¥å›´æ çº¿ä¸æ˜¾ç¤º | ç¡®è®¤ `history_days=2`ï¼Œæˆ–ç­‰å¼•æ“å¯åŠ¨çº¦60sååˆ·æ–°é¡µé¢ |
| æ—¶åŒºå¼‚å¸¸ | NautilusTrader å†…éƒ¨ä½¿ç”¨ UTC çº³ç§’ï¼›å›¾è¡¨å±•ç¤ºä½¿ç”¨ ET fake-UTC |
| å›¾è¡¨åªæ˜¾ç¤º 390 æ ¹ | æ­£å¸¸ï¼Œç›˜å‰æ•°æ®ç”¨äºæŒ‡æ ‡é¢„çƒ­ï¼Œå›¾è¡¨ä»…å±•ç¤º RTH 09:30-16:00 |
| å‰ç«¯æç¤ºã€Œå¼•æ“æœªè¿æ¥ã€ | é‡å¯ `server.js` |

## è®¢å•ç”Ÿå‘½å‘¨æœŸ

`OrderGatewayActor` å®ç°å®Œæ•´çš„è®¢å•å›è°ƒï¼Œé€šè¿‡ Redis `order:update` é¢‘é“æ¨é€ç»™å‰ç«¯ï¼š

| çŠ¶æ€ | è¯­éŸ³/Toast |
|------|-----------|
| ACCEPTED | `QQQ è®¢å•å·²æ¥å—` âœ… |
| FILLED | `QQQ åšå¤šè®¢å•æˆäº¤ï¼Œæˆäº¤ä»· xxx` âœ… |
| PARTIALLY_FILLED | `QQQ è®¢å•éƒ¨åˆ†æˆäº¤` ğŸ”¶ |
| REJECTED | `QQQ è®¢å•è¢«äº¤æ˜“æ‰€æ‹’ç»` âŒ |
| DENIED | `QQQ è®¢å•è¢«é£æ§æ‹’ç»` âŒ |
| TRIGGERED | `QQQ æ­¢æŸå•å·²è§¦å‘ï¼Œæ³¨æ„` ğŸ”” |
| CANCELED | ä»… Toastï¼Œä¸è¯­éŸ³ |
| EXPIRED | `QQQ è®¢å•å·²è¿‡æœŸ` |

## çœŸå® IBKR ä»“ä½å¯¹æ¥

```
æˆäº¤ â†’ strategy.py on_position_changed()
   â†’ redis.publish("position:update", {...})
   â†’ server.js psubscribe("position:*")
   â†’ WebSocket å¹¿æ’­ â†’ index.html / multi.html å®æ—¶åˆ·æ–°ä»“ä½é¢æ¿
```

- å­—æ®µï¼š`avg_px_open`ï¼ˆå‡ä»·ï¼‰ã€`unrealized_pnl`ï¼ˆæµ®ç›ˆï¼‰ã€`side`ï¼ˆå¤š/ç©ºï¼‰
- æ¯æ ¹ K çº¿æ”¶ç›˜æ—¶è‡ªåŠ¨é‡ç®—æµ®ç›ˆï¼ˆæ”¯æŒåšç©ºæ–¹å‘ï¼‰
- å¹³ä»“æ¨é€ `{closed: true}` è‡ªåŠ¨æ¸…ç©ºé¢æ¿

## è´¦æˆ·èµ„é‡‘å®æ—¶å±•ç¤º

å¼•æ“é€šè¿‡ `msgbus.subscribe(topic="events.account.*")` ç›‘å¬ NautilusTrader AccountState äº‹ä»¶ï¼ˆIBKR è‡ªåŠ¨æ¯çº¦3åˆ†é’Ÿåˆ·æ–°ï¼‰ï¼š

```
IBKR reqAccountSummary â†’ AccountState äº‹ä»¶
   â†’ strategy.py _on_account_state()
   â†’ redis.set("account:funds", {...})
   â†’ redis.publish("account:update", {...})
   â†’ server.js psubscribe("account:*")
   â†’ WebSocket å¹¿æ’­ â†’ å·¥å…·æ è´¦æˆ·é¢æ¿å®æ—¶åˆ·æ–°
```

**å·¥å…·æ æ˜¾ç¤ºå­—æ®µ**ï¼šNet Liqï¼ˆå‡€èµ„äº§ï¼‰/ Availableï¼ˆå¯ç”¨èµ„é‡‘ï¼Œç»¿è‰²ï¼‰/ Currency / Updatedï¼ˆæ›´æ–°æ—¶é—´ï¼‰

**Redis æ•°æ®æ ¼å¼**ï¼š
```json
{ "account_id": "INTERACTIVE_BROKERS-F10251881", "balances": [{ "currency": "USD", "total": 719.49, "free": 719.49, "locked": 0.00 }], "ts": 1709012345 }
```

**éªŒè¯å‘½ä»¤**ï¼š
```bash
redis-cli get account:funds
# æ‰‹åŠ¨æ³¨å…¥æµ‹è¯•å‰ç«¯ï¼ˆå¼•æ“æœªå¯åŠ¨æ—¶ï¼‰
redis-cli set account:funds '{"account_id":"test","balances":[{"currency":"USD","total":150000,"free":98000,"locked":52000}],"ts":1709012345}'
```
