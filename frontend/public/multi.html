<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Chart Dashboard</title>
    <script
        src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #131722;
            color: #d1d4dc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€ é¡¶éƒ¨å¯¼èˆªæ  â”€â”€ */
        #nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 14px;
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
            flex-shrink: 0;
        }

        #nav h1 {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-links a {
            font-size: 12px;
            color: #787b86;
            text-decoration: none;
            padding: 3px 10px;
            border-radius: 4px;
            transition: background .15s;
        }

        .nav-links a:hover {
            background: #2a2e39;
            color: #d1d4dc;
        }

        .nav-links a.active {
            background: rgba(41, 98, 255, .15);
            color: #2962ff;
        }

        /* â”€â”€ 2Ã—2 ç½‘æ ¼ â”€â”€ */
        #grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            background: #2a2e39;
            overflow: hidden;
        }

        /* â”€â”€ å•å…ƒæ ¼ â”€â”€ */
        .cell {
            background: #131722;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* â”€â”€ å•å…ƒæ ¼å¤´éƒ¨ï¼ˆä¸ index.html #toolbar å¯¹é½ï¼‰ â”€â”€ */
        .c-toolbar {
            display: flex;
            align-items: center;
            padding: 4px 10px;
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
            flex-shrink: 0;
            min-height: 52px;
            gap: 0;
        }

        /* å·¦åˆ— */
        .c-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .c-left-r1 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .c-left-r2 {
            display: flex;
            align-items: center;
            min-height: 16px;
        }

        .c-symbol {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
        }

        .c-price {
            font-size: 14px;
            font-weight: 600;
        }

        .c-change {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 3px;
        }

        /* åå­—çº¿ OHLC */
        .c-crosshair {
            display: none;
            align-items: center;
            gap: 0;
            font-size: 11px;
            font-family: 'Roboto Mono', monospace, sans-serif;
        }

        .c-ci-item {
            display: flex;
            align-items: center;
            margin-right: 8px;
        }

        .c-ci-label {
            color: #787b86;
            margin-right: 2px;
            font-size: 10px;
        }

        .c-ci-val {
            font-weight: 600;
            font-size: 11px;
            color: #d1d4dc;
        }

        .c-ci-time {
            color: #4b5563;
            font-size: 10px;
            margin-right: 10px;
        }

        /* å³åˆ— */
        .c-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        /* ä»“ä½é¢æ¿ */
        .c-pos-panel {
            display: none;
            background: rgba(30, 34, 45, .6);
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 11px;
            line-height: 1.6;
        }

        .c-pos-row {
            display: flex;
            gap: 12px;
        }

        .c-pos-item label {
            color: #787b86;
            margin-right: 3px;
        }

        .c-pos-item span {
            font-weight: 600;
        }

        /* æ“ä½œæŒ‰é’®åŒº */
        .c-actions {
            display: flex;
            align-items: center;
            gap: 7px;
        }

        /* æ ‡çš„åˆ‡æ¢ä¸‹æ‹‰ */
        .c-sym-sel {
            background: #131722;
            color: #d1d4dc;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
        }

        /* ST è·Ÿè¸ªæ­¢ç›ˆ toggle */
        .c-toggle-wrap {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #787b86;
        }

        .c-toggle {
            position: relative;
            display: inline-block;
            width: 30px;
            height: 17px;
        }

        .c-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .c-slider {
            position: absolute;
            inset: 0;
            background: #2a2e39;
            border-radius: 17px;
            cursor: pointer;
            transition: background .2s;
        }

        .c-slider:before {
            content: '';
            position: absolute;
            width: 11px;
            height: 11px;
            left: 3px;
            top: 3px;
            background: #d1d4dc;
            border-radius: 50%;
            transition: transform .2s;
        }

        .c-toggle input:checked+.c-slider {
            background: #26a69a;
        }

        .c-toggle input:checked+.c-slider:before {
            transform: translateX(13px);
        }

        /* æŒ‰é’® */
        .c-btn {
            padding: 3px 10px;
            border-radius: 4px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity .15s;
        }

        .c-btn:hover {
            opacity: .82;
        }

        .c-btn-open {
            background: #26a69a;
            color: #fff;
        }

        .c-btn-close {
            background: #ef5350;
            color: #fff;
        }

        /* â”€â”€ å›¾è¡¨åŒº â”€â”€ */
        .c-chart-wrap {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .c-chart {
            width: 100%;
            height: 100%;
        }

        /* å›¾ä¾‹ */
        .c-legend {
            position: absolute;
            top: 6px;
            left: 8px;
            display: flex;
            gap: 10px;
            font-size: 10px;
            pointer-events: none;
            z-index: 10;
        }

        .c-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .c-legend-dot {
            width: 8px;
            height: 2px;
            border-radius: 1px;
        }

        /* åŠ è½½é®ç½© */
        .c-loading {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #131722;
            font-size: 13px;
            color: #787b86;
            z-index: 100;
        }

        /* é¢œè‰²å·¥å…·ç±» */
        .up {
            color: #26a69a;
        }

        .down {
            color: #ef5350;
        }

        .up-bg {
            background: rgba(38, 166, 154, .15);
        }

        .down-bg {
            background: rgba(239, 83, 80, .15);
        }

        /* â”€â”€ æ­¢æŸè¯ä¸¸æ‹–åŠ¨æ§ä»¶ â”€â”€ */
        .sl-handle {
            display: none;
            position: absolute;
            right: 58px;
            transform: translateY(-50%);
            align-items: center;
            gap: 5px;
            background: #ef5350;
            border-radius: 16px;
            padding: 4px 10px 4px 8px;
            cursor: ns-resize;
            z-index: 50;
            user-select: none;
            box-shadow: 0 2px 8px rgba(239, 83, 80, .5);
            white-space: nowrap;
            font-size: 11px;
        }

        .sl-handle.active {
            display: flex;
        }

        @keyframes sl-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, .5), 0 2px 8px rgba(239, 83, 80, .5);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 83, 80, 0), 0 2px 8px rgba(239, 83, 80, .5);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, 0), 0 2px 8px rgba(239, 83, 80, .5);
            }
        }

        .sl-handle.active {
            animation: sl-pulse 2s infinite;
        }

        .sl-handle:active {
            animation: none;
        }

        .sl-handle .sl-icon {
            flex-shrink: 0;
            opacity: .9;
        }

        .sl-handle .sl-label {
            color: rgba(255, 255, 255, .75);
            font-weight: 500;
        }

        .sl-handle .sl-price {
            font-family: 'Roboto Mono', monospace, sans-serif;
            font-weight: 700;
            color: #fff;
            font-size: 12px;
        }

        /* â”€â”€ å†…åµŒè®¢å•é¢æ¿ â”€â”€ */
        .order-panel {
            display: none;
            position: absolute;
            top: 8px;
            right: 58px;
            width: 190px;
            background: rgba(19, 23, 34, .97);
            border: 1px solid #2a2e39;
            border-radius: 10px;
            padding: 12px 14px;
            z-index: 60;
            color: #d1d4dc;
        }

        .order-panel.active {
            display: block;
        }

        .op-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .op-hdr-title {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }

        .op-x {
            background: none;
            border: none;
            color: #787b86;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .op-dir-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .op-dir-badge.buy {
            background: rgba(38, 166, 154, .18);
            color: #26a69a;
            border: 1px solid #26a69a;
        }

        .op-dir-badge.sell {
            background: rgba(239, 83, 80, .18);
            color: #ef5350;
            border: 1px solid #ef5350;
        }

        .op-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .op-lbl {
            font-size: 10px;
            color: #787b86;
        }

        .op-calc {
            font-size: 11px;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace, sans-serif;
        }

        .op-field input {
            width: 75px;
            background: #1e222d;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            color: #d1d4dc;
            font-size: 11px;
            padding: 3px 6px;
            text-align: right;
        }

        .op-field input:focus {
            outline: none;
            border-color: #434651;
        }

        .op-divider {
            height: 1px;
            background: #2a2e39;
            margin: 5px 0;
        }

        .op-hint {
            font-size: 9px;
            color: #787b86;
            margin-top: 4px;
            text-align: center;
        }

        .op-footer {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .op-btn {
            flex: 1;
            padding: 5px 0;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .op-btn.cancel {
            background: #2a2e39;
            color: #d1d4dc;
        }

        .op-btn.confirm {
            background: #26a69a;
            color: #fff;
        }

        .op-btn.confirm.sell {
            background: #ef5350;
        }

        .op-btn:hover {
            opacity: .85;
        }
    </style>
</head>

<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div id="nav">
        <h1>ğŸ“ˆ Trading Dashboard</h1>
        <div class="nav-links">
            <a href="/">å•å›¾æ¨¡å¼</a>
            <a href="/multi.html" class="active">âŠ å››å›¾æ€»è§ˆ</a>
        </div>
    </div>

    <!-- 2Ã—2 ç½‘æ ¼ï¼ˆç”± JS åŠ¨æ€ç”Ÿæˆï¼‰ -->
    <div id="grid"></div>


    <script>
        // â”€â”€ é»˜è®¤å››ä¸ªæ ‡çš„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const DEFAULT_SYMBOLS = ['QQQ', 'AAPL', 'NVDA', 'TSLA'];
        const state = {};

        // å…¨å±€æ‹–åŠ¨çŠ¶æ€ï¼ˆåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªé¢æ¿åœ¨æ‹–åŠ¨ï¼‰
        let activeDrag = null;

        // â”€â”€ ç”Ÿæˆå•å…ƒæ ¼ HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createCell(symbol) {
            const id = symbol;
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${id}`;
            cell.innerHTML = `
        <!-- å·¥å…·æ  -->
        <div class="c-toolbar">
          <!-- å·¦åˆ— -->
          <div class="c-left">
            <div class="c-left-r1">
              <span class="c-symbol">${symbol}</span>
              <span class="c-price up" id="price-${id}">â€”</span>
              <span class="c-change up-bg up" id="change-${id}">â€”</span>
            </div>
            <div class="c-left-r2">
              <!-- åå­—çº¿ OHLC -->
              <div class="c-crosshair" id="ci-${id}">
                <span class="c-ci-time"  id="ci-time-${id}"></span>
                <span class="c-ci-item"><span class="c-ci-label">O</span><span class="c-ci-val" id="ci-o-${id}"></span></span>
                <span class="c-ci-item"><span class="c-ci-label">H</span><span class="c-ci-val" style="color:#26a69a" id="ci-h-${id}"></span></span>
                <span class="c-ci-item"><span class="c-ci-label">L</span><span class="c-ci-val" style="color:#ef5350" id="ci-l-${id}"></span></span>
                <span class="c-ci-item"><span class="c-ci-label">C</span><span class="c-ci-val" id="ci-c-${id}"></span></span>
              </div>
            </div>
          </div>
          <!-- å³åˆ— -->
          <div class="c-right">
            <!-- ä»“ä½é¢æ¿ -->
            <div class="c-pos-panel" id="pos-panel-${id}">
              <div class="c-pos-row">
                <div class="c-pos-item"><label>å¼€ä»“ä»·</label><span id="p-entry-${id}">â€”</span></div>
                <div class="c-pos-item"><label>æ­¢æŸ</label><span id="p-sl-${id}" style="color:#ef5350">â€”</span></div>
                <div class="c-pos-item"><label>æ•°é‡</label><span id="p-qty-${id}">â€”</span></div>
                <div class="c-pos-item">
                  <label>ç›ˆäº</label>
                  <span id="p-pnl-${id}">â€”</span>
                  <span id="p-pnl-pct-${id}" style="font-size:10px;margin-left:3px">â€”</span>
                </div>
              </div>
            </div>
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="c-actions">
              <div class="c-toggle-wrap">
                <label class="c-toggle">
                  <input type="checkbox" id="st-toggle-${id}">
                  <span class="c-slider"></span>
                </label>
                <span id="st-label-${id}">STæ­¢ç›ˆ</span>
              </div>
              <div style="width:1px;height:18px;background:#2a2e39"></div>
              <button class="c-btn c-btn-open"  id="btn-open-${id}">å¼€ä»“</button>
              <button class="c-btn c-btn-close" id="btn-close-${id}">å¹³ä»“</button>
            </div>
          </div>
        </div>

        <!-- å›¾è¡¨åŒº -->
        <div class="c-chart-wrap" id="wrap-${id}">
          <div class="c-loading" id="loading-${id}">â³ åŠ è½½ä¸­â€¦</div>
          <div class="c-chart"  id="chart-${id}"></div>
          <!-- å›¾ä¾‹ -->
          <div class="c-legend">
            <div class="c-legend-item"><div class="c-legend-dot" style="background:#26a69a"></div><span style="color:#26a69a">STâ†‘</span></div>
            <div class="c-legend-item"><div class="c-legend-dot" style="background:#ef5350"></div><span style="color:#ef5350">STâ†“</span></div>
          </div>
          <!-- æ­¢æŸè¯ä¸¸æ‹–åŠ¨æ§ä»¶ -->
          <div class="sl-handle" id="slh-${id}" title="ä¸Šä¸‹æ‹–åŠ¨è°ƒæ•´æ­¢æŸä»·">
            <svg class="sl-icon" width="10" height="13" viewBox="0 0 10 13" fill="none">
              <path d="M5 0L9 4H1L5 0Z" fill="white"/>
              <path d="M5 13L1 9H9L5 13Z" fill="white"/>
              <rect x="4" y="4" width="2" height="5" rx="1" fill="white" opacity=".5"/>
            </svg>
            <span class="sl-label">æ­¢æŸ</span>
            <span class="sl-price">â€”</span>
          </div>
          <!-- å†…åµŒè®¢å•é¢æ¿ -->
          <div class="order-panel" id="op-${id}">
            <div class="op-hdr">
              <span class="op-hdr-title" id="opt-${id}">å¼€ä»“</span>
              <button class="op-x" id="opx-${id}">âœ•</button>
            </div>
            <div class="op-dir-badge buy" id="opd-${id}">â–² åšå¤š</div>
            <div class="op-field">
              <span class="op-lbl">æœ€å¤§äºæŸ</span>
              <input type="number" id="opm-${id}" value="100" min="1" step="1">
            </div>
            <div class="op-field">
              <span class="op-lbl">æ­¢æŸä»·</span>
              <span class="op-calc op-sl-val" style="color:#ef5350">â€”</span>
            </div>
            <div class="op-divider"></div>
            <div class="op-field"><span class="op-lbl">å»ºè®®è‚¡æ•°</span><span class="op-calc" id="opq-${id}">â€”</span></div>
            <div class="op-field"><span class="op-lbl">æ¯è‚¡é£é™©</span><span class="op-calc" id="opr-${id}" style="color:#ef5350">â€”</span></div>
            <div class="op-field"><span class="op-lbl">æ­¢æŸå¹…åº¦</span><span class="op-calc" id="ops-${id}" style="color:#ef5350">â€”</span></div>
            <div class="op-field"><span class="op-lbl">å¼€ä»“é‡‘é¢</span><span class="op-calc" id="opc-${id}">â€”</span></div>
            <div class="op-hint" id="oph-${id}"></div>
            <div class="op-footer">
              <button class="op-btn cancel" id="opcancel-${id}">å–æ¶ˆ</button>
              <button class="op-btn confirm" id="opconfirm-${id}">ç¡®è®¤åšå¤š</button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('grid').appendChild(cell);
        }

        // â”€â”€ åˆå§‹åŒ–å›¾è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function initChart(symbol) {
            const chartEl = document.getElementById(`chart-${symbol}`);
            const chart = LightweightCharts.createChart(chartEl, {
                layout: { background: { color: '#131722' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: '#2a2e39' },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false, fixLeftEdge: true },
            });

            const candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderUpColor: '#26a69a', borderDownColor: '#ef5350',
                wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });

            // è‡ªé€‚åº”å¤§å°
            new ResizeObserver(() => {
                const r = chartEl.getBoundingClientRect();
                chart.applyOptions({ width: r.width, height: r.height });
            }).observe(chartEl);

            // åå­—çº¿ OHLC
            const ciBox = document.getElementById(`ci-${symbol}`);
            chart.subscribeCrosshairMove(param => {
                if (!param || !param.time || !param.seriesData?.size) {
                    ciBox.style.display = 'none'; return;
                }
                const bar = param.seriesData.get(candleSeries);
                if (!bar) { ciBox.style.display = 'none'; return; }
                const d = new Date(param.time * 1000);
                const hh = String(d.getUTCHours()).padStart(2, '0');
                const mm = String(d.getUTCMinutes()).padStart(2, '0');
                document.getElementById(`ci-time-${symbol}`).textContent = `${hh}:${mm}`;
                const fmt = v => v.toFixed(2);
                const bull = bar.close >= bar.open;
                const ciO = document.getElementById(`ci-o-${symbol}`);
                const ciC = document.getElementById(`ci-c-${symbol}`);
                ciO.textContent = fmt(bar.open);
                document.getElementById(`ci-h-${symbol}`).textContent = fmt(bar.high);
                document.getElementById(`ci-l-${symbol}`).textContent = fmt(bar.low);
                ciC.textContent = fmt(bar.close);
                ciO.style.color = ciC.style.color = bull ? '#26a69a' : '#ef5350';
                ciBox.style.display = 'flex';
            });

            state[symbol] = {
                symbol, chart, candleSeries,
                stSeriesList: [], stLastDir: null, stLastSeries: null,
            };
        }

        // â”€â”€ SuperTrend åˆ†æ®µç»˜åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createSegmentedST(symbol, bars) {
            const s = state[symbol];
            s.stSeriesList.forEach(ser => s.chart.removeSeries(ser));
            s.stSeriesList = []; s.stLastDir = null; s.stLastSeries = null;
            let currentDir = null, segData = [];

            function flush() {
                if (!segData.length) return;
                const color = currentDir === 1 ? '#26a69a' : '#ef5350';
                const ser = s.chart.addLineSeries({
                    color, lineWidth: 2,
                    crosshairMarkerVisible: false, lastValueVisible: false, priceLineVisible: false,
                });
                ser.setData(segData);
                s.stSeriesList.push(ser);
                s.stLastSeries = ser;
                s.stLastDir = currentDir;
            }

            for (const bar of bars) {
                if (bar.st_value == null || bar.st_dir == null) continue;
                if (bar.st_dir !== currentDir) { flush(); currentDir = bar.st_dir; segData = []; }
                segData.push({ time: bar.time, value: bar.st_value });
            }
            flush();
        }

        // â”€â”€ å¼€ç›˜åŒºé—´ OR High/Low â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function addOpeningRange(symbol, bars) {
            const { candleSeries } = state[symbol];
            const or = bars.slice(0, 15);
            if (!or.length) return;
            const orH = Math.max(...or.map(b => b.high));
            const orL = Math.min(...or.map(b => b.low));
            [{ price: orH, title: `OR High ${orH.toFixed(2)}` },
            { price: orL, title: `OR Low  ${orL.toFixed(2)}` }].forEach(({ price, title }) => {
                candleSeries.createPriceLine({
                    price, color: '#f59e0b', lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true, title,
                });
            });
        }

        // â”€â”€ ä»“ä½å±•ç¤ºï¼ˆå…¼å®¹çœŸå® IBKR æ•°æ®æ ¼å¼å’Œæ—§ Redis æ ¼å¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // çœŸå® IBKR å­—æ®µï¼šavg_px_open / unrealized_pnl / side / quantity / stop_loss
        // æ—§ Redis å­—æ®µï¼š entry_price / pnl / pnl_pct / quantity / entry_time / stop_loss
        function addPositionLines(symbol, position) {
            if (!position) return;
            const { candleSeries } = state[symbol];

            const entryPrice = position.avg_px_open ?? position.entry_price;
            const stopLoss = position.stop_loss;
            const qty = position.quantity;
            const side = position.side || 'LONG';
            const isLong = side !== 'SHORT';
            const entryTime = position.entry_time;

            if (!entryPrice) return;

            // ä¿å­˜ä»“ä½åˆ° stateï¼Œä¾›è¡Œæƒ…å˜åŠ¨æ—¶åˆ·æ–°æµ®ç›ˆ
            state[symbol].position = position;

            // å¼€ä»“ä»·çº¿ï¼ˆè“è‰²è™šçº¿ï¼‰
            candleSeries.createPriceLine({
                price: entryPrice, color: '#2196f3', lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true,
                title: `å¼€ä»“ ${typeof entryPrice === 'number' ? entryPrice.toFixed(2) : entryPrice}`,
            });

            // æ­¢æŸä»·çº¿ï¼ˆçº¢è‰²è™šçº¿ï¼Œæ— æ­¢æŸæ—¶ä¸ç”»ï¼‰
            if (stopLoss) {
                candleSeries.createPriceLine({
                    price: stopLoss, color: '#ef5350', lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true, title: `æ­¢æŸ ${stopLoss}`,
                });
            }

            // å¼€ä»“ Markerï¼ˆæœ‰å…¥åœºæ—¶é—´æ—¶æ‰ç”»ï¼‰
            if (entryTime) {
                candleSeries.setMarkers([{
                    time: entryTime,
                    position: isLong ? 'belowBar' : 'aboveBar',
                    color: '#2196f3',
                    shape: isLong ? 'arrowUp' : 'arrowDown',
                    text: `${isLong ? 'BUY' : 'SELL'} @${entryPrice}`, size: 1,
                }]);
            }

            refreshPositionPanel(symbol, position);
            document.getElementById(`pos-panel-${symbol}`).style.display = 'block';
        }

        function refreshPositionPanel(symbol, position) {
            if (!position) return;
            const entryPrice = position.avg_px_open ?? position.entry_price;
            const qty = position.quantity;
            const side = position.side || 'LONG';
            const isLong = side !== 'SHORT';

            let pnl = position.unrealized_pnl ?? position.pnl;
            let pnlPct = position.pnl_pct;

            // çœŸå®æ•°æ®å®æ—¶é‡ç®—æµ®ç›ˆ%
            if (position.unrealized_pnl != null && entryPrice && qty > 0) {
                pnlPct = parseFloat((position.unrealized_pnl / (entryPrice * qty) * 100).toFixed(2));
            }

            const pnlEl = document.getElementById(`p-pnl-${symbol}`);
            const pnlPctEl = document.getElementById(`p-pnl-pct-${symbol}`);
            const fmt = v => typeof v === 'number' ? v.toFixed(2) : v;

            document.getElementById(`p-entry-${symbol}`).textContent = entryPrice ? fmt(entryPrice) : 'â€”';
            document.getElementById(`p-sl-${symbol}`).textContent = position.stop_loss ?? 'â€”';
            document.getElementById(`p-qty-${symbol}`).textContent = `${qty ?? 'â€”'}è‚¡(${isLong ? 'å¤š' : 'ç©º'})`;

            if (pnl != null) {
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}${fmt(pnl)}`;
                pnlEl.className = pnl >= 0 ? 'up' : 'down';
            } else { pnlEl.textContent = 'â€”'; pnlEl.className = ''; }

            if (pnlPct != null) {
                pnlPctEl.textContent = `(${pnlPct >= 0 ? '+' : ''}${fmt(pnlPct)}%)`;
                pnlPctEl.className = pnlPct >= 0 ? 'up' : 'down';
            } else { pnlPctEl.textContent = ''; }
        }

        function clearPositionUI(symbol) {
            state[symbol].position = null;
            document.getElementById(`pos-panel-${symbol}`).style.display = 'none';
            document.getElementById(`p-entry-${symbol}`).textContent = 'â€”';
            document.getElementById(`p-sl-${symbol}`).textContent = 'â€”';
            document.getElementById(`p-qty-${symbol}`).textContent = 'â€”';
            document.getElementById(`p-pnl-${symbol}`).textContent = 'â€”';
            document.getElementById(`p-pnl-pct-${symbol}`).textContent = '';
        }


        // â”€â”€ å·¥å…·æ ä»·æ ¼æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateHeader(symbol, bars) {
            if (!bars || bars.length < 2) return;
            const last = bars[bars.length - 1];
            const change = last.close - bars[0].open;
            const pct = (change / bars[0].open * 100).toFixed(2);
            const priceEl = document.getElementById(`price-${symbol}`);
            const changeEl = document.getElementById(`change-${symbol}`);
            priceEl.textContent = last.close.toFixed(2);
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${pct}%)`;
            const c = change >= 0 ? 'up' : 'down';
            priceEl.className = `c-price ${c}`;
            changeEl.className = `c-change ${c} ${c}-bg`;
        }

        // â”€â”€ åŠ è½½å•ä¸ªæ ‡çš„æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadSymbol(symbol) {
            try {
                const res = await fetch(`/api/data/${symbol}`);
                if (!res.ok) throw new Error((await res.json()).error);
                const { m1_bars, position } = await res.json();

                document.getElementById(`loading-${symbol}`).style.display = 'none';

                // K çº¿
                state[symbol].candleSeries.setData(m1_bars.map(b => ({
                    time: b.time, open: b.open, high: b.high, low: b.low, close: b.close,
                })));

                createSegmentedST(symbol, m1_bars);
                addOpeningRange(symbol, m1_bars);
                addPositionLines(symbol, position);
                updateHeader(symbol, m1_bars);

                state[symbol].chart.timeScale().scrollToRealTime();

                // â”€â”€ æ„å»ºæ­¢æŸæ‹–åŠ¨ ctx â”€â”€
                const s = state[symbol];
                const lastBar = m1_bars[m1_bars.length - 1];
                const lastST = [...m1_bars].reverse().find(b => b.st_value != null && b.st_value !== 0);
                const id = symbol;
                const ctx = {
                    sym: symbol, cs: s.candleSeries, chart: s.chart,
                    wrapEl: document.getElementById(`wrap-${id}`),
                    chartEl: document.getElementById(`chart-${id}`),
                    handleEl: document.getElementById(`slh-${id}`),
                    panelEl: document.getElementById(`op-${id}`),
                    latestClose: lastBar.close,
                    latestST: lastST ? lastST.st_value : null,
                    latestSTDir: lastST ? lastST.st_dir : null,
                    slPrice: null, slPriceLine: null, orderDir: 'BUY', orderMode: false,
                    // è®¢å•é¢æ¿å­å…ƒç´ 
                    dirBadgeEl: document.getElementById(`opd-${id}`),
                    panelTitleEl: document.getElementById(`opt-${id}`),
                    qtyEl: document.getElementById(`opq-${id}`),
                    riskEl: document.getElementById(`opr-${id}`),
                    slPctEl: document.getElementById(`ops-${id}`),
                    costEl: document.getElementById(`opc-${id}`),
                    hintEl: document.getElementById(`oph-${id}`),
                    maxLossEl: document.getElementById(`opm-${id}`),
                    confirmBtn: document.getElementById(`opconfirm-${id}`),
                };
                s.ctx = ctx;

                // æ­¢æŸæ§ä»¶ mousedown â†’ å¼€å§‹æ‹–åŠ¨
                ctx.handleEl.addEventListener('mousedown', e => {
                    if (!ctx.orderMode) return;
                    activeDrag = ctx;
                    document.body.style.cursor = 'ns-resize';
                    e.preventDefault();
                });

                // æœ€å¤§äºæŸè¾“å…¥ â†’ é‡ç®—
                document.getElementById(`opm-${id}`).addEventListener('input', () => updateOrderPanel(ctx));

                // å–æ¶ˆ / âœ• å…³é—­
                document.getElementById(`opcancel-${id}`).addEventListener('click', () => exitOrderMode(ctx));
                document.getElementById(`opx-${id}`).addEventListener('click', () => exitOrderMode(ctx));

                // ç¡®è®¤å¼€ä»“ â€”â€” å®é™…è°ƒç”¨å¼•æ“ API
                document.getElementById(`opconfirm-${id}`).addEventListener('click', async () => {
                    const sl = ctx.slPrice;
                    const entry = ctx.latestClose || 0;
                    const maxLoss = parseFloat(ctx.maxLossEl.value) || 100;
                    const riskPerShare = Math.abs(entry - sl);

                    const acct = ctx.accountInfo || {};
                    const available = acct.available_cash || 0;
                    const total = acct.total_equity || 0;
                    const cashCap = available > 0 ? Math.min(available * 0.9, total) : Infinity;
                    const qtyByLoss = riskPerShare > 0 ? Math.floor(maxLoss / riskPerShare) : 0;
                    const qtyByCash = cashCap < Infinity && entry > 0 ? Math.floor(cashCap / entry) : Infinity;
                    const qty = Math.min(qtyByLoss, qtyByCash);

                    if (!sl || qty <= 0) { alert('æ­¢æŸä»·æ— æ•ˆæˆ–æ¯è‚¡é£é™©è¿‡å°'); return; }

                    const confirmed = confirm(
                        `ç¡®è®¤å¼€ä»“ï¼Ÿ\næ–¹å‘: ${ctx.orderDir === 'BUY' ? 'â–² åšå¤š' : 'â–¼ åšç©º'}\n` +
                        `æ ‡çš„: ${symbol}  æ•°é‡: ${qty} è‚¡\n` +
                        `å¼€ä»“: å¸‚ä»· (~$${entry.toFixed(2)})  æ­¢æŸ: $${sl.toFixed(2)}\n` +
                        `é¢„è®¡èµ„é‡‘: $${(qty * entry).toFixed(0)}`
                    );
                    if (!confirmed) return;

                    try {
                        const resp = await fetch(`/api/order/${symbol}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ side: ctx.orderDir, qty, stop_loss: sl, order_type: 'BRACKET' }),
                        });
                        const result = await resp.json();
                        if (result.engine_offline || result.error) {
                            alert(`âš  å¼•æ“æœªè¿æ¥æˆ–å‡ºé”™: ${result.error || 'è¯·å¯åŠ¨å¼•æ“'}`);
                        } else {
                            alert(`âœ… å¼€ä»“è¯·æ±‚å·²å‘é€åˆ°å¼•æ“\n${symbol} ${ctx.orderDir === 'BUY' ? 'åšå¤š' : 'åšç©º'} x${qty}\næ­¢æŸ: $${sl.toFixed(2)}`);
                        }
                    } catch (e) { alert(`ç½‘ç»œé”™è¯¯: ${e.message}`); }
                    exitOrderMode(ctx);
                });


                // å›¾è¡¨ç¼©æ”¾/æ»šåŠ¨åé‡ç½®æ§ä»¶ä½ç½®
                s.chart.timeScale().subscribeVisibleLogicalRangeChange(() => {
                    if (ctx.orderMode) snapHandle(ctx);
                });

            } catch (e) {
                const el = document.getElementById(`loading-${symbol}`);
                if (el) el.textContent = `âŒ ${e.message}`;
            }
        }


        // â”€â”€ äº‹ä»¶ç»‘å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function bindEvents(symbol) {
            const s = state[symbol];

            // å¼€ä»“æŒ‰é’® â†’ è¿›å…¥æ­¢æŸæ‹–åŠ¨æ¨¡å¼
            document.getElementById(`btn-open-${symbol}`).addEventListener('click', () => {
                if (!s.ctx) return;
                enterOrderMode(s.ctx);
            });

            // å¹³ä»“
            document.getElementById(`btn-close-${symbol}`).addEventListener('click', async () => {
                if (!confirm(`ç¡®è®¤å¹³ä»“ ${symbol}ï¼Ÿ`)) return;
                await fetch(`/api/position/${symbol}`, { method: 'DELETE' });
                location.reload();
            });

            // ST è·Ÿè¸ªæ­¢ç›ˆ
            document.getElementById(`st-toggle-${symbol}`).addEventListener('change', async e => {
                const on = e.target.checked;
                await fetch(`/api/settings/${symbol}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ st_trail: on }),
                });
                const lbl = document.getElementById(`st-label-${symbol}`);
                lbl.style.color = on ? '#26a69a' : '#787b86';
            });
        }

        // â”€â”€ å…¨å±€æ‹–åŠ¨äº‹ä»¶ï¼ˆç»‘åœ¨ document å±‚ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('mousemove', e => {
            if (!activeDrag) return;
            const { wrapEl, chartEl, handleEl } = activeDrag;
            const wRect = wrapEl.getBoundingClientRect();
            const eRect = chartEl.getBoundingClientRect();
            const containerY = e.clientY - wRect.top;
            const chartY = e.clientY - eRect.top;
            const price = activeDrag.cs.coordinateToPrice(chartY);
            if (price === null) return;
            handleEl.style.top = containerY + 'px';
            activeDrag.slPrice = parseFloat(price.toFixed(2));
            updateHandlePriceLabel(activeDrag);
            updateOrderPanel(activeDrag);
        });

        document.addEventListener('mouseup', () => {
            if (!activeDrag) return;
            snapHandle(activeDrag);
            document.body.style.cursor = '';
            activeDrag = null;
        });

        // æ­¢æŸæ§ä»¶ç²¾ç¡®å¯¹é½ï¼ˆpriceToCoordinate + offsetï¼‰
        function snapHandle(ctx) {
            const y = ctx.cs.priceToCoordinate(ctx.slPrice);
            if (y === null) return;
            const offset = ctx.chartEl.getBoundingClientRect().top - ctx.wrapEl.getBoundingClientRect().top;
            ctx.handleEl.style.top = (y + offset) + 'px';
        }

        // æ›´æ–°è¯ä¸¸ä»·æ ¼æ ‡ç­¾
        function updateHandlePriceLabel(ctx) {
            ctx.handleEl.querySelector('.sl-price').textContent = ctx.slPrice.toFixed(2);
            const el = ctx.panelEl.querySelector('.op-sl-val');
            if (el) el.textContent = ctx.slPrice.toFixed(2);
        }

        // æ ¸å¿ƒï¼šè‡ªåŠ¨åˆ¤æ–¹å‘ + ç®—è‚¡æ•°ï¼ˆåŒä¸Šé™ï¼‰ + æ›´æ–°é¢æ¿
        function updateOrderPanel(ctx) {
            const entry = ctx.latestClose || 0;
            if (!ctx.slPrice || !entry) return;
            const { slPrice } = ctx;

            const isBuy = slPrice < entry;
            ctx.orderDir = isBuy ? 'BUY' : 'SELL';
            ctx.dirBadgeEl.className = `op-dir-badge ${isBuy ? 'buy' : 'sell'}`;
            ctx.dirBadgeEl.textContent = isBuy ? 'â–² åšå¤š' : 'â–¼ åšç©º';
            ctx.panelTitleEl.textContent = isBuy ? 'åšå¤šå¼€ä»“' : 'åšç©ºå¼€ä»“';
            ctx.confirmBtn.className = `op-btn confirm ${isBuy ? '' : 'sell'}`;
            ctx.confirmBtn.textContent = isBuy ? 'ç¡®è®¤åšå¤š' : 'ç¡®è®¤åšç©º';

            const riskPerShare = Math.abs(entry - slPrice);
            const slPct = entry > 0 ? (riskPerShare / entry * 100) : 0;
            ctx.riskEl.textContent = riskPerShare > 0 ? `$${riskPerShare.toFixed(2)}` : 'â€”';
            ctx.slPctEl.textContent = slPct > 0 ? `${slPct.toFixed(2)}%` : 'â€”';

            // â”€â”€ è‚¡æ•°ï¼šæœ€å¤§äºæŸ + èµ„é‡‘ä¸Šé™ å–è¾ƒå°å€¤ â”€â”€
            const maxLoss = parseFloat(ctx.maxLossEl.value) || 100;
            const acct = ctx.accountInfo || {};
            const available = acct.available_cash || 0;
            const total = acct.total_equity || 0;
            const cashCap = available > 0 ? Math.min(available * 0.9, total) : Infinity;
            const qtyByLoss = riskPerShare > 0 ? Math.floor(maxLoss / riskPerShare) : 0;
            const qtyByCash = cashCap < Infinity && entry > 0 ? Math.floor(cashCap / entry) : Infinity;
            const qty = Math.min(qtyByLoss, qtyByCash);
            ctx.qtyEl.textContent = qty > 0 ? `${qty} è‚¡` : 'â€”';
            ctx.qtyEl.style.color = qty > 0 ? '#d1d4dc' : '#787b86';
            ctx.qtyEl.title = (qty > 0 && qtyByCash < qtyByLoss)
                ? `æŒ‰æ­¢æŸå¯å¼€ ${qtyByLoss} è‚¡ï¼Œå› èµ„é‡‘ä¸Šé™æŠ½åˆ° ${qty} è‚¡` : '';

            const cost = qty * entry;
            ctx.costEl.textContent = qty > 0 ? `$${cost.toFixed(0)}` : 'â€”';
            if (qty > 0 && total > 0) {
                ctx.hintEl.textContent = `ğŸ’¡ å ç”¨ $${cost.toFixed(0)}ï¼ˆè´¦æˆ·$${(total / 10000).toFixed(1)}ä¸‡çš„ ${(cost / total * 100).toFixed(1)}%ï¼‰`;
            } else if (qty > 0) {
                ctx.hintEl.textContent = `ğŸ’¡ å ç”¨ $${cost.toFixed(0)}ï¼ˆå¼•æ“æœªè¿æ¥ï¼Œèµ„é‡‘æ ¡éªŒå·²è·³è¿‡ï¼‰`;
            } else {
                ctx.hintEl.textContent = 'è¯·æ‹–åŠ¨æ­¢æŸæ§ä»¶';
            }
            if (ctx.slPriceLine) {
                ctx.slPriceLine.applyOptions({ price: slPrice, title: `æ­¢æŸ ${slPrice.toFixed(2)}` });
            }
        }

        // è¿›å…¥å¼€ä»“æ¨¡å¼ï¼ˆå¼‚æ­¥è·å–çœŸå®è´¦æˆ·ä½™é¢ï¼‰
        async function enterOrderMode(ctx) {
            try {
                const resp = await fetch('/api/account');
                const data = await resp.json();
                ctx.accountInfo = { ...data, engine_online: !data.engine_offline };
            } catch (e) {
                ctx.accountInfo = { total_equity: 0, available_cash: 0, engine_online: false };
            }

            const initSL = ctx.latestST
                ? ctx.latestST
                : (ctx.latestClose ? ctx.latestClose * 0.99 : 0);
            ctx.slPrice = parseFloat(initSL.toFixed(2));
            ctx.slPriceLine = ctx.cs.createPriceLine({
                price: ctx.slPrice, color: '#ef5350', lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true, title: `æ­¢æŸ ${ctx.slPrice.toFixed(2)}`,
            });
            ctx.orderMode = true;
            ctx.handleEl.classList.add('active');
            ctx.panelEl.classList.add('active');
            updateHandlePriceLabel(ctx);
            updateOrderPanel(ctx);
            snapHandle(ctx);
        }

        // é€€å‡ºå¼€ä»“æ¨¡å¼
        function exitOrderMode(ctx) {
            ctx.orderMode = false;
            if (ctx.slPriceLine) { ctx.cs.removePriceLine(ctx.slPriceLine); ctx.slPriceLine = null; }
            ctx.handleEl.classList.remove('active');
            ctx.panelEl.classList.remove('active');
            activeDrag = null;
            document.body.style.cursor = '';
        }


        // â”€â”€ WebSocket å®æ—¶æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function connectWS() {
            const ws = new WebSocket('ws://localhost:3000');
            ws.onmessage = ({ data }) => {
                try {
                    const { channel, data: payload } = JSON.parse(data);

                    // â”€â”€ çœŸå® IBKR ä»“ä½æ¨é€ï¼ˆæ—  :symbol åç¼€ï¼Œæå‰å¤„ç†ï¼‰â”€â”€
                    if (channel === 'position:update') {
                        const posSym = payload.symbol;
                        if (posSym && state[posSym]) {
                            if (payload.closed) {
                                clearPositionUI(posSym);
                            } else {
                                state[posSym].candleSeries.setMarkers([]);
                                addPositionLines(posSym, payload);
                            }
                        }
                        return;
                    }

                    // â”€â”€ ç¬¬ä¸€æ­¥ï¼šä» channel æœ«æ®µæå– symbol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    const sym = DEFAULT_SYMBOLS.find(s => channel.endsWith(`:${s}`));
                    if (!sym || !state[sym]) return;

                    // â”€â”€ ç¬¬äºŒæ­¥ï¼špayload.symbol äºŒæ¬¡æ ¡éªŒï¼ˆé˜²æ­¢æ•°æ®ä¸²å°ï¼‰â”€â”€â”€â”€â”€
                    if (payload.symbol && payload.symbol !== sym) {
                        console.error(`[WSä¸²å°æ‹¦æˆª] channel=${channel} å¯¹åº” ${sym}ï¼Œä½† payload.symbol=${payload.symbol}ï¼Œå·²ä¸¢å¼ƒ`);
                        return;
                    }


                    const s = state[sym];

                    // tick å®æ—¶æ¨é€ï¼šè®°å½•æœ€æ–° tick æ—¶é—´
                    if (channel.startsWith('bars:1m:tick:')) {
                        s.lastTickTime = payload.time;
                        s.candleSeries.update({
                            time: payload.time, open: payload.open,
                            high: payload.high, low: payload.low, close: payload.close,
                        });
                        return;
                    }
                    // kline:1m: æ”¶ç›˜â€”â€”ç«æ€é˜²æŠ¤ï¼štick å·²æ¨è¿›ä¸‹ä¸€åˆ†é’Ÿåˆ™è·³è¿‡ candleSeries.update
                    if (channel.startsWith('kline:1m:')) {
                        if (payload.time >= (s.lastTickTime || 0)) {
                            s.candleSeries.update({
                                time: payload.time, open: payload.open,
                                high: payload.high, low: payload.low, close: payload.close,
                            });
                        }
                        // è¡Œæƒ…å˜åŠ¨ï¼šæ›´æ–° latestCloseï¼Œåˆ·æ–°ä»“ä½æµ®ç›ˆé¢æ¿
                        if (s.ctx) s.ctx.latestClose = payload.close;
                        const priceEl = document.getElementById(`price-${sym}`);
                        if (priceEl) priceEl.textContent = payload.close.toFixed(2);
                        if (s.position) {
                            const pos = s.position;
                            const ep = pos.avg_px_open ?? pos.entry_price;
                            if (ep) {
                                pos.unrealized_pnl =
                                    (payload.close - ep) * pos.quantity *
                                    (pos.side === 'SHORT' ? -1 : 1);
                                refreshPositionPanel(sym, pos);
                            }
                        }
                        if (payload.st_value != null && payload.st_value !== 0) {
                            if (payload.st_dir !== s.stLastDir || !s.stLastSeries) {
                                const color = payload.st_dir === 1 ? '#26a69a' : '#ef5350';
                                s.stLastSeries = s.chart.addLineSeries({
                                    color, lineWidth: 2,
                                    crosshairMarkerVisible: false, lastValueVisible: false, priceLineVisible: false,
                                });
                                s.stSeriesList.push(s.stLastSeries);
                                s.stLastDir = payload.st_dir;
                            }
                            s.stLastSeries.update({ time: payload.time, value: payload.st_value });
                        }
                        return;
                    }




                } catch (err) {
                    console.error('[WSå¤„ç†é”™è¯¯]', err.message, err);
                }
            };
            ws.onclose = () => setTimeout(connectWS, 3000);
        }

        // â”€â”€ å¯åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        DEFAULT_SYMBOLS.forEach(sym => {
            createCell(sym);
            initChart(sym);
            bindEvents(sym);
        });
        Promise.all(DEFAULT_SYMBOLS.map(sym => loadSymbol(sym)));
        connectWS();
    </script>
</body>

</html>