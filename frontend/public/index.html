<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard</title>
  <script
    src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #131722;
      color: #d1d4dc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ é¡¶éƒ¨å·¥å…·æ ï¼šå·¦å³ä¸¤åˆ—ï¼Œå³ä¾§åˆ†ä¸¤è¡Œ â”€â”€ */
    #toolbar {
      display: flex;
      align-items: center;
      padding: 6px 16px;
      background: #1e222d;
      border-bottom: 1px solid #2a2e39;
      flex-shrink: 0;
      min-height: 58px;
    }

    /* å·¦åˆ—ï¼šsymbol + price + OHLC æ‚¬æµ® */
    #tb-left {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    #tb-left-row1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #tb-left-row2 {
      display: flex;
      align-items: center;
      min-height: 18px;
    }

    #symbol-label {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
    }

    #price-label {
      font-size: 18px;
      font-weight: 600;
    }

    #price-change {
      font-size: 13px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .up {
      color: #26a69a;
    }

    .down {
      color: #ef5350;
    }

    .up-bg {
      background: rgba(38, 166, 154, .15);
    }

    .down-bg {
      background: rgba(239, 83, 80, .15);
    }

    /* åå­—çº¿ OHLCï¼ˆTradingView é£æ ¼ï¼‰æ”¾ left-row2 */
    #crosshair-info {
      display: none;
      align-items: center;
      gap: 0;
      font-size: 12px;
      font-family: 'Roboto Mono', monospace, sans-serif;
    }

    .ohlc-item {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }

    .ohlc-label {
      color: #787b86;
      margin-right: 3px;
      font-size: 11px;
    }

    .ohlc-val {
      font-weight: 600;
      font-size: 12px;
      color: #d1d4dc;
    }

    .ohlc-time {
      color: #4b5563;
      font-size: 11px;
      margin-right: 12px;
    }

    /* å³åˆ—ï¼šä¸¤è¡Œ */
    #tb-right {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    /* å³åˆ—ç¬¬ä¸€è¡Œï¼šä»“ä½ä¿¡æ¯ */
    #position-panel {
      display: none;
      background: rgba(30, 34, 45, .6);
      border: 1px solid #2a2e39;
      border-radius: 5px;
      padding: 4px 12px;
      font-size: 12px;
      line-height: 1.7;
    }

    #position-panel .row {
      display: flex;
      gap: 18px;
    }

    #position-panel .item label {
      color: #787b86;
      margin-right: 4px;
    }

    #position-panel .item span {
      font-weight: 600;
    }

    /* å³åˆ—ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰é’® */
    #trade-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* å›¾è¡¨åŒº */
    #chart-container {
      flex: 1;
      position: relative;
    }

    #chart {
      width: 100%;
      height: 100%;
    }

    /* å›¾ä¾‹ */
    #legend {
      position: absolute;
      top: 8px;
      left: 12px;
      display: flex;
      gap: 16px;
      font-size: 12px;
      pointer-events: none;
      z-index: 10;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-dot {
      width: 10px;
      height: 3px;
      border-radius: 2px;
    }

    /* åŠ è½½æç¤º */
    #loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #131722;
      font-size: 16px;
      color: #787b86;
      z-index: 100;
    }

    /* ä»“ä½æ“ä½œæŒ‰é’®åŒº */
    #trade-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .btn {
      padding: 5px 14px;
      border-radius: 5px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }

    .btn:hover {
      opacity: .82;
    }

    .btn-open {
      background: #26a69a;
      color: #fff;
    }

    .btn-close {
      background: #ef5350;
      color: #fff;
    }

    /* ST è·Ÿè¸ªæ­¢ç›ˆ toggle */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #787b86;
    }

    .toggle {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      background: #2a2e39;
      border-radius: 20px;
      cursor: pointer;
      transition: background .2s;
    }

    .slider:before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      left: 3px;
      top: 3px;
      background: #d1d4dc;
      border-radius: 50%;
      transition: transform .2s;
    }

    .toggle input:checked+.slider {
      background: #26a69a;
    }

    .toggle input:checked+.slider:before {
      transform: translateX(16px);
    }

    /* å¼¹çª— */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: #1e222d;
      border: 1px solid #2a2e39;
      border-radius: 10px;
      padding: 24px 28px;
      min-width: 300px;
    }

    .modal h3 {
      margin-bottom: 16px;
      font-size: 15px;
      color: #fff;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: #787b86;
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal input {
      width: 100%;
      background: #131722;
      border: 1px solid #2a2e39;
      color: #d1d4dc;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 13px;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .modal-btns button {
      padding: 6px 18px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    #modal-cancel {
      background: #2a2e39;
      color: #d1d4dc;
    }

    #modal-confirm {
      background: #26a69a;
      color: #fff;
    }
  </style>
</head>

<body>

  <div id="toolbar">
    <!-- å·¦åˆ—ï¼šsymbol + price + OHLC æ‚¬æµ® -->
    <div id="tb-left">
      <div id="tb-left-row1">
        <a href="/multi.html" style="font-size:11px;color:#787b86;text-decoration:none;
                  padding:2px 8px;border:1px solid #2a2e39;border-radius:4px;
                  margin-right:4px;white-space:nowrap;" title="å››å›¾æ€»è§ˆ">âŠ å››å›¾</a>
        <a href="/indicators.html" style="font-size:11px;color:#787b86;text-decoration:none;
                  padding:2px 8px;border:1px solid #2a2e39;border-radius:4px;
                  margin-right:6px;white-space:nowrap;" title="STç§¯åˆ†æ’è¡Œ">ğŸ“Š ç§¯åˆ†</a>
        <span id="symbol-label">QQQ</span>
        <span id="price-label" class="up">â€”</span>
        <span id="price-change" class="up-bg up">â€”</span>
      </div>
      <div id="tb-left-row2">
        <!-- åå­—çº¿ OHLCï¼ˆTradingView é£æ ¼ï¼‰ -->
        <div id="crosshair-info">
          <span class="ohlc-time" id="ci-time"></span>
          <span class="ohlc-item"><span class="ohlc-label">O</span><span class="ohlc-val" id="ci-o"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">H</span><span class="ohlc-val" style="color:#26a69a"
              id="ci-h"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">L</span><span class="ohlc-val" style="color:#ef5350"
              id="ci-l"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">C</span><span class="ohlc-val" id="ci-c"></span></span>
        </div>
      </div>
    </div>

    <!-- å³åˆ—ï¼šä¸¤è¡Œ -->
    <div id="tb-right">
      <!-- ç¬¬ä¸€è¡Œï¼šä»“ä½ä¿¡æ¯ -->
      <div id="position-panel">
        <div class="row">
          <div class="item"><label>å¼€ä»“ä»·</label><span id="p-entry">â€”</span></div>
          <div class="item"><label>æ­¢æŸä»·</label><span id="p-sl" style="color:#ef5350">â€”</span></div>
          <div class="item"><label>æ•°é‡</label><span id="p-qty">â€”</span></div>
          <div class="item">
            <label>ç›ˆäº</label>
            <span id="p-pnl">â€”</span>
            <span id="p-pnl-pct" style="font-size:11px;margin-left:4px">â€”</span>
          </div>
        </div>
      </div>
      <!-- ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰é’® -->
      <div id="trade-actions">
        <!-- æ ‡çš„åˆ‡æ¢ä¸‹æ‹‰ -->
        <select id="symbol-select"
          style="background:#131722;color:#d1d4dc;border:1px solid #2a2e39;border-radius:4px;padding:3px 8px;font-size:13px;cursor:pointer;">
          <option value="QQQ">QQQ</option>
          <option value="AAPL">AAPL</option>
          <option value="NVDA">NVDA</option>
          <option value="TSLA">TSLA</option>
        </select>
        <div style="width:1px;height:22px;background:#2a2e39"></div>
        <div class="toggle-wrap">
          <label class="toggle">
            <input type="checkbox" id="st-trail-toggle">
            <span class="slider"></span>
          </label>
          <span id="st-trail-label">STè·Ÿè¸ªæ­¢ç›ˆ</span>
        </div>
        <div style="width:1px;height:22px;background:#2a2e39"></div>
        <button class="btn btn-open" id="btn-open">å¼€ä»“</button>
        <button class="btn btn-close" id="btn-close">å¹³ä»“</button>
      </div>
    </div>
  </div>

  <div id="chart-container">
    <div id="loading">â³ åŠ è½½æ•°æ®ä¸­â€¦</div>
    <div id="chart"></div>
    <div id="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background:#26a69a"></div>
        <span style="color:#26a69a">SuperTrendâ†‘</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:#ef5350"></div>
        <span style="color:#ef5350">SuperTrendâ†“</span>
      </div>
    </div>
  </div>

  <!-- å¼€ä»“å¼¹çª—ï¼ˆå¿…é¡»åœ¨ script ä¹‹å‰ï¼Œå¦åˆ™ JS è·å–ä¸åˆ°å…ƒç´ ï¼‰ -->
  <div class="modal-backdrop" id="open-modal">
    <div class="modal">
      <h3>å¼€ä»“</h3>
      <label>å¼€ä»“ä»·</label>
      <input type="number" id="m-entry" step="0.01" placeholder="å¦‚ 600.28">
      <label>æ­¢æŸä»·</label>
      <input type="number" id="m-sl" step="0.01" placeholder="å¦‚ 599.28">
      <label>æ•°é‡ï¼ˆè‚¡ï¼‰</label>
      <input type="number" id="m-qty" value="1" min="1">
      <div class="modal-btns">
        <button id="modal-cancel">å–æ¶ˆ</button>
        <button id="modal-confirm">ç¡®è®¤å¼€ä»“</button>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€â”€ é…ç½®ï¼šä» URL ?symbol=XXX è¯»å–æ ‡çš„ï¼Œé»˜è®¤ QQQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const urlParams = new URLSearchParams(window.location.search);
    let SYMBOL = (urlParams.get('symbol') || 'QQQ').toUpperCase();

    // â”€â”€â”€ å›¾è¡¨åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const chartEl = document.getElementById("chart");
    const chart = LightweightCharts.createChart(chartEl, {
      layout: {
        background: { color: "#131722" },
        textColor: "#d1d4dc",
      },
      grid: {
        vertLines: { color: "#1e222d" },
        horzLines: { color: "#1e222d" },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      rightPriceScale: {
        borderColor: "#2a2e39",
      },
      timeScale: {
        borderColor: "#2a2e39",
        timeVisible: true,
        secondsVisible: false,
        fixLeftEdge: true,
      },
    });

    // Kçº¿ç³»åˆ—
    const candleSeries = chart.addCandlestickSeries({
      upColor: "#26a69a",
      downColor: "#ef5350",
      borderUpColor: "#26a69a",
      borderDownColor: "#ef5350",
      wickUpColor: "#26a69a",
      wickDownColor: "#ef5350",
    });

    // SuperTrend æŒ‰æ–¹å‘æ®µåˆ›å»ºç‹¬ç«‹ LineSeries
    let stSeriesList = [];
    let stLastDir = null;
    let stLastSeries = null;  // å½“å‰æ´»è·ƒ segment çš„ series å¼•ç”¨

    // è‡ªé€‚åº”å›¾è¡¨å¤§å°
    new ResizeObserver(() => {
      const rect = chartEl.getBoundingClientRect();
      chart.applyOptions({ width: rect.width, height: rect.height });
    }).observe(chartEl);

    // â”€â”€â”€ å¼€ç›˜åŒºé—´ Opening Rangeï¼ˆRTH å¼€ç›˜åå‰15åˆ†é’Ÿ 09:30â€“09:44 ETï¼‰â”€â”€â”€â”€â”€
    function addOpeningRange(bars) {
      // 09:30 ET = fake-UTC æ—¶é—´æˆ³ 09*3600 + 30*60 = 34200
      // æ‰¾åˆ°ç¬¬ä¸€æ ¹ >= 09:30 çš„ RTH K çº¿
      const RTH_START = 9 * 3600 + 30 * 60;  // 34200 ç§’
      const rthIdx = bars.findIndex(b => (b.time % 86400) >= RTH_START);
      if (rthIdx < 0) return;  // æ—  RTH æ•°æ®
      const or = bars.slice(rthIdx, rthIdx + 15);  // 09:30â€“09:44 ET
      if (or.length === 0) return;
      const orHigh = Math.max(...or.map(b => b.high));
      const orLow = Math.min(...or.map(b => b.low));

      // OR Highï¼ˆæ©™è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: orHigh,
        color: '#f59e0b',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `OR High  ${orHigh.toFixed(2)}`,
      });
      // OR Lowï¼ˆæ©™è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: orLow,
        color: '#f59e0b',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `OR Low  ${orLow.toFixed(2)}`,
      });
    }

    // â”€â”€â”€ ä»“ä½çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addPositionLines(position) {
      if (!position) return;

      // å¼€ä»“ä»·ï¼ˆè“è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: position.entry_price,
        color: "#2196f3",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `å¼€ä»“ ${position.entry_price}`,
      });

      // æ­¢æŸä»·ï¼ˆçº¢è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: position.stop_loss,
        color: "#ef5350",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `æ­¢æŸ ${position.stop_loss}`,
      });

      // å¼€ä»“ Marker
      candleSeries.setMarkers([{
        time: position.entry_time,
        position: "belowBar",
        color: "#2196f3",
        shape: "arrowUp",
        text: `BUY @${position.entry_price}`,
        size: 1,
      }]);

      // æ›´æ–°ä»“ä½é¢æ¿
      const pnlEl = document.getElementById("p-pnl");
      const pnlPct = document.getElementById("p-pnl-pct");
      document.getElementById("p-entry").textContent = position.entry_price;
      document.getElementById("p-sl").textContent = position.stop_loss;
      document.getElementById("p-qty").textContent = `${position.quantity} è‚¡`;
      pnlEl.textContent = `${position.pnl >= 0 ? "+" : ""}${position.pnl}`;
      pnlPct.textContent = `(${position.pnl_pct >= 0 ? "+" : ""}${position.pnl_pct}%)`;
      pnlEl.className = position.pnl >= 0 ? "up" : "down";
      pnlPct.className = position.pnl >= 0 ? "up" : "down";
      document.getElementById("position-panel").style.display = "block";
    }

    // â”€â”€â”€ ä»·æ ¼æ›´æ–°å·¥å…·æ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateToolbar(bars) {
      if (!bars || bars.length < 2) return;
      const last = bars[bars.length - 1];
      const first = bars[0];
      const change = last.close - first.open;
      const changePct = (change / first.open * 100).toFixed(2);
      const priceEl = document.getElementById("price-label");
      const changeEl = document.getElementById("price-change");
      priceEl.textContent = last.close.toFixed(2);
      changeEl.textContent = `${change >= 0 ? "+" : ""}${change.toFixed(2)} (${changePct}%)`;
      const cls = change >= 0 ? "up" : "down";
      const clsBg = change >= 0 ? "up-bg" : "down-bg";
      priceEl.className = cls;
      changeEl.className = `${cls} ${clsBg}`;
    }

    // SuperTrend æŒ‰æ–¹å‘æ®µåˆ›å»ºç‹¬ç«‹ LineSeriesï¼Œåˆ‡æ¢ç‚¹è‡ªç„¶æ–­å¼€
    function createSegmentedST(bars) {
      // æ¸…é™¤æ—§ series
      stSeriesList.forEach(s => chart.removeSeries(s));
      stSeriesList = [];
      stLastDir = null;

      let currentDir = null;
      let segData = [];

      function flushSegment() {
        if (segData.length === 0) return;
        const color = currentDir === 1 ? '#26a69a' : '#ef5350';
        const s = chart.addLineSeries({
          color,
          lineWidth: 2,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
          priceLineVisible: false,
        });
        s.setData(segData);
        stSeriesList.push(s);
      }

      for (const bar of bars) {
        if (bar.st_value === null || bar.st_dir === null) continue;
        if (bar.st_dir !== currentDir) {
          flushSegment();
          currentDir = bar.st_dir;
          segData = [];
        }
        segData.push({ time: bar.time, value: bar.st_value });
      }
      flushSegment();  // æœ€åä¸€æ®µ
      stLastDir = currentDir;
    }

    // â”€â”€â”€ åŠ è½½æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData() {
      try {
        const res = await fetch(`/api/data/${SYMBOL}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }
        const { symbol, m1_bars, position } = await res.json();

        document.getElementById("symbol-label").textContent = symbol;
        document.getElementById("loading").style.display = "none";

        // Kçº¿
        const ohlcData = m1_bars.map(b => ({
          time: b.time, open: b.open, high: b.high, low: b.low, close: b.close
        }));
        candleSeries.setData(ohlcData);

        // SuperTrend æŒ‰æ®µæ–­å¼€
        createSegmentedST(m1_bars);

        // å¼€ç›˜åŒºé—´ï¼ˆå‰15åˆ†é’Ÿ OR High / OR Lowï¼‰
        addOpeningRange(m1_bars);

        // ä»“ä½çº¿
        addPositionLines(position);

        // å·¥å…·æ ä»·æ ¼
        updateToolbar(m1_bars);

        // è·³åˆ°æœ€æ–°æ•°æ®
        chart.timeScale().scrollToRealTime();

      } catch (e) {
        document.getElementById("loading").textContent = `âŒ ${e.message}`;
        console.error(e);
      }
    }

    // â”€â”€â”€ åå­—çº¿ OHLC æ‚¬æµ®ä¿¡æ¯ï¼ˆTradingView é£æ ¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ciBox = document.getElementById('crosshair-info');
    const ciTime = document.getElementById('ci-time');
    const ciO = document.getElementById('ci-o');
    const ciH = document.getElementById('ci-h');
    const ciL = document.getElementById('ci-l');
    const ciC = document.getElementById('ci-c');

    chart.subscribeCrosshairMove(param => {
      if (!param || !param.time || !param.seriesData || !param.seriesData.size) {
        ciBox.style.display = 'none';
        return;
      }
      const bar = param.seriesData.get(candleSeries);
      if (!bar) { ciBox.style.display = 'none'; return; }

      // fake-UTC å­˜å‚¨ï¼šç›´æ¥è¯» getUTCHours å³ä¸º ET æœ¬åœ°æ—¶é—´
      const d = new Date(param.time * 1000);
      const hh = String(d.getUTCHours()).padStart(2, '0');
      const mm = String(d.getUTCMinutes()).padStart(2, '0');
      ciTime.textContent = `${hh}:${mm} ET`;

      const fmt = v => v.toFixed(2);
      const bull = bar.close >= bar.open;
      ciO.textContent = fmt(bar.open);
      ciH.textContent = fmt(bar.high);
      ciL.textContent = fmt(bar.low);
      ciC.textContent = fmt(bar.close);
      ciC.style.color = bull ? '#26a69a' : '#ef5350';
      ciO.style.color = bull ? '#26a69a' : '#ef5350';

      ciBox.style.display = 'flex';
    });

    // â”€â”€â”€ WebSocket å®æ—¶æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastTickTime = 0;  // è®°å½•æœ€è¿‘ä¸€æ¬¡ tick çš„æ—¶é—´æˆ³ï¼Œé˜²æ­¢ kline:1m: æ—¶é—´å›é€€
    function connectWS() {
      const ws = new WebSocket(`ws://localhost:3000`);
      ws.onmessage = ({ data }) => {
        try {
          const { channel, data: payload } = JSON.parse(data);

          // â”€â”€ Symbol è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰æ ‡çš„çš„æ¶ˆæ¯ï¼Œå…¶ä»– symbol çš„ tick/kline ç›´æ¥ä¸¢å¼ƒ â”€â”€
          // server ä¼šå¹¿æ’­æ‰€æœ‰ 4 ä¸ª symbol çš„æ¶ˆæ¯ï¼Œä¸è¿‡æ»¤ä¼šå¯¼è‡´æ—¶é—´æˆ³æ··ä¹±
          if (!channel.endsWith(`:${SYMBOL}`)) return;

          // K çº¿ tick å®æ—¶æ¨é€ï¼ˆæ›´æ–°å½“å‰æœªå®Œæˆ K çº¿ï¼‰
          if (channel.startsWith("bars:1m:tick:")) {
            lastTickTime = payload.time;
            candleSeries.update({
              time: payload.time, open: payload.open,
              high: payload.high, low: payload.low, close: payload.close,
            });
            return;
          }

          // K çº¿æ”¶ç›˜ï¼ˆkline:1m:ï¼‰â€”â€”ç«æ€é˜²æŠ¤ï¼štick å·²æ¨è¿›ä¸‹ä¸€åˆ†é’Ÿåˆ™è·³è¿‡ candleSeries.update
          if (channel.startsWith("kline:1m:")) {
            if (payload.time >= lastTickTime) {
              candleSeries.update({
                time: payload.time, open: payload.open,
                high: payload.high, low: payload.low, close: payload.close,
              });
            }
            const priceEl = document.getElementById("price-label");
            if (priceEl) priceEl.textContent = payload.close.toFixed(2);
            if (payload.st_value != null && payload.st_value !== 0) {
              if (payload.st_dir !== stLastDir || stLastSeries === null) {
                const color = payload.st_dir === 1 ? '#26a69a' : '#ef5350';
                stLastSeries = chart.addLineSeries({
                  color, lineWidth: 2,
                  crosshairMarkerVisible: false, lastValueVisible: false, priceLineVisible: false,
                });
                stSeriesList.push(stLastSeries);
                stLastDir = payload.st_dir;
              }
              stLastSeries.update({ time: payload.time, value: payload.st_value });
            }
          }
        } catch (err) {
          console.error('[WSå¤„ç†é”™è¯¯]', err.message, err);
        }
      };
      ws.onclose = () => setTimeout(connectWS, 3000);
    }

    // â”€â”€â”€ ä»“ä½æ“ä½œæŒ‰é’®é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const openModal = document.getElementById('open-modal');

    // å¼€ä»“æŒ‰é’®
    document.getElementById('btn-open').addEventListener('click', () => {
      openModal.classList.add('open');
    });

    // å–æ¶ˆ
    document.getElementById('modal-cancel').addEventListener('click', () => {
      openModal.classList.remove('open');
    });
    openModal.addEventListener('click', e => {
      if (e.target === openModal) openModal.classList.remove('open');
    });

    // ç¡®è®¤å¼€ä»“
    document.getElementById('modal-confirm').addEventListener('click', async () => {
      const entry = parseFloat(document.getElementById('m-entry').value);
      const sl = parseFloat(document.getElementById('m-sl').value);
      const qty = parseInt(document.getElementById('m-qty').value, 10);
      if (isNaN(entry) || isNaN(sl) || isNaN(qty)) {
        alert('è¯·å…ˆå¡«å†™å¼€ä»“ä»·ã€æ­¢æŸä»·å’Œæ•°é‡');
        return;
      }
      await fetch(`/api/position/${SYMBOL}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          entry_price: entry,
          stop_loss: sl,
          quantity: qty,
          // ä¸ä¼  entry_timeï¼Œè®© server.js æœåŠ¡ç«¯ç»Ÿä¸€è½¬æ¢ä¸º ET fake-UTC
        }),
      });
      openModal.classList.remove('open');
      location.reload();
    });

    // å¹³ä»“æŒ‰é’®
    document.getElementById('btn-close').addEventListener('click', async () => {
      if (!confirm('ç¡®è®¤å¹³ä»“ï¼Ÿ')) return;
      await fetch(`/api/position/${SYMBOL}`, { method: 'DELETE' });
      location.reload();
    });

    // ST è·Ÿè¸ªæ­¢ç›ˆ toggle
    let stTrailEnabled = false;
    document.getElementById('st-trail-toggle').addEventListener('change', async e => {
      stTrailEnabled = e.target.checked;
      await fetch(`/api/settings/${SYMBOL}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ st_trail: stTrailEnabled }),
      });
      const lbl = document.getElementById('st-trail-label');
      lbl.style.color = stTrailEnabled ? '#26a69a' : '#787b86';
    });

    // â”€â”€â”€ æ ‡çš„åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const symbolSelect = document.getElementById('symbol-select');
    symbolSelect.value = SYMBOL;
    symbolSelect.addEventListener('change', () => {
      window.location.href = `/?symbol=${symbolSelect.value}`;
    });

    // å¯åŠ¨
    loadData();
    connectWS();
  </script>
</body>

</html>