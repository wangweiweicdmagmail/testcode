<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard</title>
  <script
    src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #131722;
      color: #d1d4dc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ é¡¶éƒ¨å·¥å…·æ ï¼šå·¦å³ä¸¤åˆ—ï¼Œå³ä¾§åˆ†ä¸¤è¡Œ â”€â”€ */
    #toolbar {
      display: flex;
      align-items: center;
      padding: 6px 16px;
      background: #1e222d;
      border-bottom: 1px solid #2a2e39;
      flex-shrink: 0;
      min-height: 58px;
    }

    /* å·¦åˆ—ï¼šsymbol + price + OHLC æ‚¬æµ® */
    #tb-left {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    #tb-left-row1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #tb-left-row2 {
      display: flex;
      align-items: center;
      min-height: 18px;
    }

    #symbol-label {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
    }

    #price-label {
      font-size: 18px;
      font-weight: 600;
    }

    #price-change {
      font-size: 13px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .up {
      color: #26a69a;
    }

    .down {
      color: #ef5350;
    }

    .up-bg {
      background: rgba(38, 166, 154, .15);
    }

    .down-bg {
      background: rgba(239, 83, 80, .15);
    }

    /* åå­—çº¿ OHLCï¼ˆTradingView é£æ ¼ï¼‰æ”¾ left-row2 */
    #crosshair-info {
      display: none;
      align-items: center;
      gap: 0;
      font-size: 12px;
      font-family: 'Roboto Mono', monospace, sans-serif;
    }

    .ohlc-item {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }

    .ohlc-label {
      color: #787b86;
      margin-right: 3px;
      font-size: 11px;
    }

    .ohlc-val {
      font-weight: 600;
      font-size: 12px;
      color: #d1d4dc;
    }

    .ohlc-time {
      color: #4b5563;
      font-size: 11px;
      margin-right: 12px;
    }

    /* å³åˆ—ï¼šä¸¤è¡Œ */
    #tb-right {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    /* å³åˆ—ç¬¬ä¸€è¡Œï¼šä»“ä½ä¿¡æ¯ */
    #position-panel {
      display: none;
      background: rgba(30, 34, 45, .6);
      border: 1px solid #2a2e39;
      border-radius: 5px;
      padding: 4px 12px;
      font-size: 12px;
      line-height: 1.7;
    }

    #position-panel .row {
      display: flex;
      gap: 18px;
    }

    #position-panel .item label {
      color: #787b86;
      margin-right: 4px;
    }

    #position-panel .item span {
      font-weight: 600;
    }

    /* å³åˆ—ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰é’® */
    #trade-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* å›¾è¡¨åŒº */
    #chart-container {
      flex: 1;
      position: relative;
    }

    #chart {
      width: 100%;
      height: 100%;
    }

    /* å›¾ä¾‹ */
    #legend {
      position: absolute;
      top: 8px;
      left: 12px;
      display: flex;
      gap: 16px;
      font-size: 12px;
      pointer-events: none;
      z-index: 10;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-dot {
      width: 10px;
      height: 3px;
      border-radius: 2px;
    }

    /* åŠ è½½æç¤º */
    #loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #131722;
      font-size: 16px;
      color: #787b86;
      z-index: 100;
    }

    /* ä»“ä½æ“ä½œæŒ‰é’®åŒº */
    #trade-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .btn {
      padding: 5px 14px;
      border-radius: 5px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }

    .btn:hover {
      opacity: .82;
    }

    .btn-open {
      background: #26a69a;
      color: #fff;
    }

    .btn-close {
      background: #ef5350;
      color: #fff;
    }

    /* ST è·Ÿè¸ªæ­¢ç›ˆ toggle */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #787b86;
    }

    .toggle {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      background: #2a2e39;
      border-radius: 20px;
      cursor: pointer;
      transition: background .2s;
    }

    .slider:before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      left: 3px;
      top: 3px;
      background: #d1d4dc;
      border-radius: 50%;
      transition: transform .2s;
    }

    .toggle input:checked+.slider {
      background: #26a69a;
    }

    .toggle input:checked+.slider:before {
      transform: translateX(16px);
    }

    /* å¼¹çª— */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: #1e222d;
      border: 1px solid #2a2e39;
      border-radius: 10px;
      padding: 24px 28px;
      min-width: 300px;
    }

    .modal h3 {
      margin-bottom: 16px;
      font-size: 15px;
      color: #fff;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: #787b86;
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal input {
      width: 100%;
      background: #131722;
      border: 1px solid #2a2e39;
      color: #d1d4dc;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 13px;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .modal-btns button {
      padding: 6px 18px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    #modal-cancel {
      background: #2a2e39;
      color: #d1d4dc;
    }

    #modal-confirm {
      background: #26a69a;
      color: #fff;
    }

    /* â”€â”€â”€ æ­¢æŸçº¿æ‹–åŠ¨å¼€ä»“ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    /* æ‹–åŠ¨æŠŠæ‰‹ï¼šæµ®åœ¨å›¾è¡¨å³ä¾§è¾¹ç¼˜ */
    /* sl-handle: one-piece pill (icon + label + price) */
    #sl-handle {
      display: none;
      position: absolute;
      right: 58px;
      transform: translateY(-50%);
      align-items: center;
      gap: 6px;
      background: #ef5350;
      border-radius: 20px;
      padding: 6px 14px 6px 10px;
      cursor: ns-resize;
      z-index: 50;
      user-select: none;
      box-shadow: 0 2px 10px rgba(239, 83, 80, .55);
      white-space: nowrap;
    }

    #sl-handle.active {
      display: flex;
    }

    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 83, 80, .5), 0 2px 10px rgba(239, 83, 80, .55);
      }

      70% {
        box-shadow: 0 0 0 8px rgba(239, 83, 80, 0), 0 2px 10px rgba(239, 83, 80, .55);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(239, 83, 80, 0), 0 2px 10px rgba(239, 83, 80, .55);
      }
    }

    #sl-handle.active {
      animation: pulse-ring 2s infinite;
    }

    #sl-handle:active {
      animation: none;
      box-shadow: 0 0 0 4px rgba(239, 83, 80, .35);
    }

    #sl-handle .sl-icon {
      flex-shrink: 0;
      opacity: .9;
    }

    #sl-handle .sl-label {
      font-size: 11px;
      color: rgba(255, 255, 255, .75);
      font-weight: 500;
      letter-spacing: .04em;
    }

    #sl-handle .sl-price {
      font-size: 14px;
      font-family: 'Roboto Mono', monospace, sans-serif;
      font-weight: 700;
      color: #fff;
    }

    /* æ‹–åŠ¨æ—¶å›¾è¡¨ä¸Šçš„é€æ˜å¯äº¤äº’è¦†ç›–å±‚ï¼ˆé˜²æ­¢ chart å¸æ”¶ mousemoveï¼‰ */
    #drag-capture {
      display: none;
      position: absolute;
      inset: 0;
      z-index: 48;
      cursor: ns-resize;
    }

    #drag-capture.active {
      display: block;
    }

    /* æµ®åŠ¨è®¢å•é¢æ¿ */
    #order-panel {
      display: none;
      position: absolute;
      top: 10px;
      right: 70px;
      width: 210px;
      background: rgba(19, 23, 34, .95);
      border: 1px solid #2a2e39;
      border-radius: 10px;
      padding: 16px;
      z-index: 60;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .5);
      backdrop-filter: blur(6px);
    }

    #order-panel.active {
      display: block;
    }

    .op-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .op-title {
      font-size: 13px;
      font-weight: 700;
      color: #fff;
    }

    .op-close-btn {
      background: none;
      border: none;
      color: #787b86;
      font-size: 16px;
      cursor: pointer;
      line-height: 1;
      padding: 0 2px;
    }

    .op-close-btn:hover {
      color: #d1d4dc;
    }

    /* BUY / SELL åˆ‡æ¢ */
    .dir-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .dir-btn {
      flex: 1;
      padding: 6px 0;
      border: 1px solid transparent;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .15s;
      background: #2a2e39;
      color: #787b86;
    }

    .dir-btn.buy.active {
      background: #26a69a;
      color: #fff;
      border-color: #26a69a;
    }

    .dir-btn.sell.active {
      background: #ef5350;
      color: #fff;
      border-color: #ef5350;
    }

    .dir-btn:not(.active):hover {
      background: #363a46;
      color: #d1d4dc;
    }

    /* å­—æ®µè¡Œ */
    .op-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .op-label {
      font-size: 11px;
      color: #787b86;
    }

    .op-field input {
      width: 95px;
      background: #1e222d;
      border: 1px solid #2a2e39;
      border-radius: 4px;
      color: #d1d4dc;
      font-size: 12px;
      padding: 4px 8px;
      text-align: right;
    }

    .op-field input:focus {
      outline: none;
      border-color: #434651;
    }

    .op-field input.sl-field {
      border-color: #ef5350;
      color: #ef5350;
    }

    #op-risk {
      font-size: 12px;
      font-weight: 600;
    }

    /* æŒ‰éˆ•è¡Œ */
    .op-footer {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }

    .op-btn {
      flex: 1;
      padding: 7px 0;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }

    .op-btn:hover {
      opacity: .82;
    }

    .op-btn.cancel {
      background: #2a2e39;
      color: #d1d4dc;
    }

    .op-btn.confirm {
      background: #26a69a;
      color: #fff;
    }

    .op-btn.confirm.sell {
      background: #ef5350;
    }

    /* è®¾ç½®éš¾åº¦æç¤º */
    .op-hint {
      font-size: 10px;
      color: #787b86;
      margin-top: 6px;
      text-align: center;
    }

    /* æ–¹å‘ badgeï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼Œåªè¯»æ˜¾ç¤ºï¼‰ */
    .op-dir-badge {
      display: inline-block;
      padding: 4px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: .04em;
    }

    .op-dir-badge.buy {
      background: rgba(38, 166, 154, .18);
      color: #26a69a;
      border: 1px solid #26a69a;
    }

    .op-dir-badge.sell {
      background: rgba(239, 83, 80, .18);
      color: #ef5350;
      border: 1px solid #ef5350;
    }

    /* åˆ†éš”çº¿ */
    .op-divider {
      height: 1px;
      background: #2a2e39;
      margin: 10px 0;
    }

    /* åªè¯»è®¡ç®—å€¼ï¼ˆè‚¡æ•°ã€é£é™©ã€é‡‘é¢ï¼‰ */
    .op-calc-val {
      font-size: 13px;
      font-weight: 700;
      font-family: 'Roboto Mono', monospace, sans-serif;
      color: #d1d4dc;
    }
  </style>
</head>

<body>

  <div id="toolbar">
    <!-- å·¦åˆ—ï¼šsymbol + price + OHLC æ‚¬æµ® -->
    <div id="tb-left">
      <div id="tb-left-row1">
        <a href="/multi.html" style="font-size:11px;color:#787b86;text-decoration:none;
                  padding:2px 8px;border:1px solid #2a2e39;border-radius:4px;
                  margin-right:4px;white-space:nowrap;" title="å››å›¾æ€»è§ˆ">âŠ å››å›¾</a>
        <a href="/indicators.html" style="font-size:11px;color:#787b86;text-decoration:none;
                  padding:2px 8px;border:1px solid #2a2e39;border-radius:4px;
                  margin-right:6px;white-space:nowrap;" title="STç§¯åˆ†æ’è¡Œ">ğŸ“Š ç§¯åˆ†</a>
        <span id="symbol-label">QQQ</span>
        <span id="price-label" class="up">â€”</span>
        <span id="price-change" class="up-bg up">â€”</span>
      </div>
      <div id="tb-left-row2">
        <!-- åå­—çº¿ OHLCï¼ˆTradingView é£æ ¼ï¼‰ -->
        <div id="crosshair-info">
          <span class="ohlc-time" id="ci-time"></span>
          <span class="ohlc-item"><span class="ohlc-label">O</span><span class="ohlc-val" id="ci-o"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">H</span><span class="ohlc-val" style="color:#26a69a"
              id="ci-h"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">L</span><span class="ohlc-val" style="color:#ef5350"
              id="ci-l"></span></span>
          <span class="ohlc-item"><span class="ohlc-label">C</span><span class="ohlc-val" id="ci-c"></span></span>
        </div>
      </div>
    </div>

    <!-- å³åˆ—ï¼šä¸¤è¡Œ -->
    <div id="tb-right">
      <!-- ç¬¬ä¸€è¡Œï¼šä»“ä½ä¿¡æ¯ -->
      <div id="position-panel">
        <div class="row">
          <div class="item"><label>å¼€ä»“ä»·</label><span id="p-entry">â€”</span></div>
          <div class="item"><label>æ­¢æŸä»·</label><span id="p-sl" style="color:#ef5350">â€”</span></div>
          <div class="item"><label>æ•°é‡</label><span id="p-qty">â€”</span></div>
          <div class="item">
            <label>ç›ˆäº</label>
            <span id="p-pnl">â€”</span>
            <span id="p-pnl-pct" style="font-size:11px;margin-left:4px">â€”</span>
          </div>
        </div>
      </div>
      <!-- ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰é’® -->
      <div id="trade-actions">
        <!-- æ ‡çš„åˆ‡æ¢ä¸‹æ‹‰ -->
        <select id="symbol-select"
          style="background:#131722;color:#d1d4dc;border:1px solid #2a2e39;border-radius:4px;padding:3px 8px;font-size:13px;cursor:pointer;">
          <option value="QQQ">QQQ</option>
          <option value="AAPL">AAPL</option>
          <option value="NVDA">NVDA</option>
          <option value="TSLA">TSLA</option>
        </select>
        <div style="width:1px;height:22px;background:#2a2e39"></div>
        <div class="toggle-wrap">
          <label class="toggle">
            <input type="checkbox" id="st-trail-toggle">
            <span class="slider"></span>
          </label>
          <span id="st-trail-label">STè·Ÿè¸ªæ­¢ç›ˆ</span>
        </div>
        <div style="width:1px;height:22px;background:#2a2e39"></div>
        <button class="btn btn-open" id="btn-open">å¼€ä»“</button>
        <button class="btn btn-close" id="btn-close">å¹³ä»“</button>
      </div>
    </div>
  </div>

  <div id="chart-container">
    <div id="loading">â³ åŠ è½½æ•°æ®ä¸­â€¦</div>
    <div id="chart"></div>
    <div id="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background:#26a69a"></div>
        <span style="color:#26a69a">SuperTrendâ†‘</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:#ef5350"></div>
        <span style="color:#ef5350">SuperTrendâ†“</span>
      </div>
    </div>

    <!-- æ­¢æŸä¸€ä½“åŒ–æ‹–åŠ¨æ§ä»¶ -->
    <div id="sl-handle" title="ä¸Šä¸‹æ‹–åŠ¨è°ƒæ•´æ­¢æŸä»·">
      <svg class="sl-icon" width="12" height="16" viewBox="0 0 12 16" fill="none">
        <path d="M6 0L10 5H2L6 0Z" fill="white" />
        <path d="M6 16L2 11H10L6 16Z" fill="white" />
        <rect x="5" y="5" width="2" height="6" rx="1" fill="white" opacity=".5" />
      </svg>
      <span class="sl-label">æ­¢æŸ</span>
      <span class="sl-price" id="sl-price-val">â€”</span>
    </div>
    <!-- æ‹–åŠ¨æˆªæ•å±‚ï¼ˆæ‹–åŠ¨æ—¶é˜²æ­¢å›¾è¡¨å¸æ”¶äº‹ä»¶ï¼‰ -->
    <div id="drag-capture"></div>

    <!-- æµ®åŠ¨è®¢å•é¢æ¿ -->
    <div id="order-panel">
      <div class="op-header">
        <!-- åŠ¨æ€æ˜¾ç¤ºåšå¤š/åšç©ºæ ‡é¢˜ -->
        <span class="op-title" id="op-title">æ–°å»ºè®¢å•</span>
        <button class="op-close-btn" id="op-close">âœ•</button>
      </div>

      <!-- æ–¹å‘ badgeï¼ˆåªè¯»ï¼Œè‡ªåŠ¨åˆ¤æ–­ï¼‰ -->
      <div id="op-dir-badge" class="op-dir-badge buy">â–² åšå¤š</div>

      <!-- æœ€å¤§äºæŸï¼ˆç”¨æˆ·è¾“å…¥ï¼‰ -->
      <div class="op-field">
        <span class="op-label">æœ€å¤§äºæŸ ($)</span>
        <input type="number" id="op-max-loss" value="100" min="1" step="1">
      </div>

      <!-- æ­¢æŸä»·ï¼ˆå¯æ‰‹åŠ¨è¾“å…¥ / æ‹–åŠ¨åŒæ­¥ï¼‰ -->
      <div class="op-field">
        <span class="op-label">æ­¢æŸä»·</span>
        <input type="number" class="sl-field" id="op-sl-input" step="0.01" readonly style="cursor:default;opacity:.75;"
          title="æ‹–åŠ¨ä¸Šæ–¹æ­¢æŸæ§ä»¶è°ƒæ•´">
      </div>

      <!-- åˆ†éš”çº¿ -->
      <div class="op-divider"></div>

      <!-- è®¡ç®—ç»“æœï¼šè‚¡æ•°ï¼ˆåªè¯»ï¼‰ -->
      <div class="op-field">
        <span class="op-label">å»ºè®®è‚¡æ•°</span>
        <span id="op-qty-display" class="op-calc-val">â€”</span>
      </div>

      <!-- æ¯è‚¡é£é™© & æ­¢æŸ% -->
      <div class="op-field">
        <span class="op-label">æ¯è‚¡é£é™©</span>
        <span id="op-risk-per-share" class="op-calc-val down">â€”</span>
      </div>
      <div class="op-field">
        <span class="op-label">æ­¢æŸå¹…åº¦</span>
        <span id="op-sl-pct" class="op-calc-val down">â€”</span>
      </div>

      <!-- é¢„è®¡å¼€ä»“é‡‘é¢ -->
      <div class="op-field">
        <span class="op-label">å¼€ä»“é‡‘é¢</span>
        <span id="op-cost" class="op-calc-val">â€”</span>
      </div>

      <!-- èµ„é‡‘å æ¯”æç¤º -->
      <div id="op-capital-hint" class="op-hint"></div>

      <div class="op-footer">
        <button class="op-btn cancel" id="op-cancel">å–æ¶ˆ</button>
        <button class="op-btn confirm" id="op-confirm">ç¡®è®¤åšå¤š</button>
      </div>
    </div>
  </div>

  <!-- å®¹å¤‡ç”¨æ˜¾ç¤ºä»“ä½''çº¿çš„èƒŒæ™¯å¼¹çª—ï¼ˆä¿ç•™ï¼Œå½“å‰ä¸ä½¿ç”¨ï¼‰ -->
  <div class="modal-backdrop" id="open-modal" style="display:none!important"></div>

  <script>
    // â”€â”€â”€ é…ç½®ï¼šä» URL ?symbol=XXX è¯»å–æ ‡çš„ï¼Œé»˜è®¤ QQQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const urlParams = new URLSearchParams(window.location.search);
    let SYMBOL = (urlParams.get('symbol') || 'QQQ').toUpperCase();

    // â”€â”€â”€ å…¨å±€çŠ¶æ€ï¼šç¼“å­˜æ•°æ®å’Œå¼€ä»“æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentBars = [];   // æœ€è¿‘åŠ è½½çš„ M1 bars
    let latestST = null; // æœ€æ–° ST å€¼
    let latestSTDir = null; // 1=å¤šå¤´ -1=ç©ºå¤´
    let latestClose = null; // æœ€æ–°æ”¶ç›˜ä»·

    // æ‹–åŠ¨å¼€ä»“æ¨¡å¼çŠ¶æ€
    let orderMode = false;
    let slPrice = null;  // å½“å‰æ­¢æŸä»·
    let slPriceLine = null;  // LWC priceLine å¯¹è±¡
    let orderDir = 'BUY'; // 'BUY' | 'SELL'
    let isDragging = false;

    // â”€â”€â”€ å›¾è¡¨åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const chartEl = document.getElementById("chart");
    const chart = LightweightCharts.createChart(chartEl, {
      layout: {
        background: { color: "#131722" },
        textColor: "#d1d4dc",
      },
      grid: {
        vertLines: { color: "#1e222d" },
        horzLines: { color: "#1e222d" },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      rightPriceScale: {
        borderColor: "#2a2e39",
      },
      timeScale: {
        borderColor: "#2a2e39",
        timeVisible: true,
        secondsVisible: false,
        fixLeftEdge: true,
      },
    });

    // Kçº¿ç³»åˆ—
    const candleSeries = chart.addCandlestickSeries({
      upColor: "#26a69a",
      downColor: "#ef5350",
      borderUpColor: "#26a69a",
      borderDownColor: "#ef5350",
      wickUpColor: "#26a69a",
      wickDownColor: "#ef5350",
    });

    // SuperTrend æŒ‰æ–¹å‘æ®µåˆ›å»ºç‹¬ç«‹ LineSeries
    let stSeriesList = [];
    let stLastDir = null;
    let stLastSeries = null;  // å½“å‰æ´»è·ƒ segment çš„ series å¼•ç”¨

    // è‡ªé€‚åº”å›¾è¡¨å¤§å°
    new ResizeObserver(() => {
      const rect = chartEl.getBoundingClientRect();
      chart.applyOptions({ width: rect.width, height: rect.height });
    }).observe(chartEl);

    // â”€â”€â”€ å¼€ç›˜åŒºé—´ Opening Rangeï¼ˆRTH å¼€ç›˜åå‰15åˆ†é’Ÿ 09:30â€“09:44 ETï¼‰â”€â”€â”€â”€â”€
    function addOpeningRange(bars) {
      // 09:30 ET = fake-UTC æ—¶é—´æˆ³ 09*3600 + 30*60 = 34200
      // æ‰¾åˆ°ç¬¬ä¸€æ ¹ >= 09:30 çš„ RTH K çº¿
      const RTH_START = 9 * 3600 + 30 * 60;  // 34200 ç§’
      const rthIdx = bars.findIndex(b => (b.time % 86400) >= RTH_START);
      if (rthIdx < 0) return;  // æ—  RTH æ•°æ®
      const or = bars.slice(rthIdx, rthIdx + 15);  // 09:30â€“09:44 ET
      if (or.length === 0) return;
      const orHigh = Math.max(...or.map(b => b.high));
      const orLow = Math.min(...or.map(b => b.low));

      // OR Highï¼ˆæ©™è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: orHigh,
        color: '#f59e0b',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `OR High  ${orHigh.toFixed(2)}`,
      });
      // OR Lowï¼ˆæ©™è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: orLow,
        color: '#f59e0b',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `OR Low  ${orLow.toFixed(2)}`,
      });
    }

    // â”€â”€â”€ ä»“ä½å±•ç¤ºï¼ˆå…¼å®¹çœŸå® IBKR æ•°æ®æ ¼å¼å’Œæ—§ Redis æ ¼å¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // çœŸå® IBKR å­—æ®µï¼šavg_px_open / unrealized_pnl / side / quantity / last_price / stop_loss
    // æ—§ Redis å­—æ®µï¼š entry_price / pnl / pnl_pct / quantity / entry_time / stop_loss
    let currentPosition = null;   // ç¼“å­˜å½“å‰ä»“ä½ï¼Œä¾›è¡Œæƒ…æ›´æ–°æ—¶åˆ·æ–°æµ®ç›ˆ

    function addPositionLines(position) {
      if (!position) return;
      currentPosition = position;

      // ç»Ÿä¸€å­—æ®µï¼šçœŸå®æ•°æ®ä¼˜å…ˆï¼Œå…œåº•æ—§æ ¼å¼
      const entryPrice = position.avg_px_open ?? position.entry_price;
      const stopLoss = position.stop_loss;
      const qty = position.quantity;
      const side = position.side || (position.entry_price ? 'LONG' : null);
      const entryTime = position.entry_time;      // æ—§æ ¼å¼æ‰æœ‰
      const isLong = side !== 'SHORT';

      if (!entryPrice) return;

      // å¼€ä»“ä»·çº¿ï¼ˆè“è‰²è™šçº¿ï¼‰
      candleSeries.createPriceLine({
        price: entryPrice,
        color: "#2196f3",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `å¼€ä»“ ${entryPrice.toFixed ? entryPrice.toFixed(2) : entryPrice}`,
      });

      // æ­¢æŸä»·çº¿ï¼ˆçº¢è‰²è™šçº¿ï¼Œæ— æ­¢æŸæ—¶ä¸ç”»ï¼‰
      if (stopLoss) {
        candleSeries.createPriceLine({
          price: stopLoss,
          color: "#ef5350",
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dashed,
          axisLabelVisible: true,
          title: `æ­¢æŸ ${stopLoss}`,
        });
      }

      // å¼€ä»“ Markerï¼ˆæœ‰å…¥åœºæ—¶é—´æ—¶æ‰ç”»ï¼‰
      if (entryTime) {
        candleSeries.setMarkers([{
          time: entryTime,
          position: isLong ? "belowBar" : "aboveBar",
          color: "#2196f3",
          shape: isLong ? "arrowUp" : "arrowDown",
          text: `${isLong ? 'BUY' : 'SELL'} @${entryPrice}`,
          size: 1,
        }]);
      }

      // é¢æ¿æ›´æ–°
      refreshPositionPanel(position);
      document.getElementById("position-panel").style.display = "block";
    }

    function refreshPositionPanel(position) {
      if (!position) return;
      const entryPrice = position.avg_px_open ?? position.entry_price;
      const stopLoss = position.stop_loss;
      const qty = position.quantity;
      const side = position.side || 'LONG';
      const isLong = side !== 'SHORT';

      // æµ®ç›ˆï¼šçœŸå®æ•°æ®ç”¨ unrealized_pnlï¼Œæ—§æ ¼å¼ç”¨ pnl
      let pnl = position.unrealized_pnl ?? position.pnl;
      let pnlPct = position.pnl_pct;   // æ—§æ ¼å¼ä¸“æœ‰ï¼›çœŸå®æ•°æ®å®æ—¶è®¡ç®—

      // çœŸå®æ•°æ®å®æ—¶é‡ç®—æµ®ç›ˆ%
      if (position.unrealized_pnl != null && entryPrice) {
        pnlPct = qty > 0 ? (position.unrealized_pnl / (entryPrice * qty) * 100) : 0;
        pnlPct = parseFloat(pnlPct.toFixed(2));
      }

      const pnlEl = document.getElementById("p-pnl");
      const pctEl = document.getElementById("p-pnl-pct");
      const fmt = v => typeof v === 'number' ? v.toFixed(2) : v;

      document.getElementById("p-entry").textContent = entryPrice ? fmt(entryPrice) : 'â€”';
      document.getElementById("p-sl").textContent = stopLoss ?? 'â€”';
      document.getElementById("p-qty").textContent = `${qty ?? 'â€”'} è‚¡ (${isLong ? 'å¤š' : 'ç©º'})`;

      if (pnl != null) {
        pnlEl.textContent = `${pnl >= 0 ? '+' : ''}${fmt(pnl)}`;
        pnlEl.className = pnl >= 0 ? 'up' : 'down';
      } else {
        pnlEl.textContent = 'â€”';
        pnlEl.className = '';
      }
      if (pnlPct != null) {
        pctEl.textContent = `(${pnlPct >= 0 ? '+' : ''}${fmt(pnlPct)}%)`;
        pctEl.className = pnlPct >= 0 ? 'up' : 'down';
      } else {
        pctEl.textContent = '';
      }
    }

    function clearPositionUI() {
      currentPosition = null;
      document.getElementById("position-panel").style.display = "none";
      document.getElementById("p-entry").textContent = "â€”";
      document.getElementById("p-sl").textContent = "â€”";
      document.getElementById("p-qty").textContent = "â€”";
      document.getElementById("p-pnl").textContent = "â€”";
      document.getElementById("p-pnl-pct").textContent = "";
    }


    // â”€â”€â”€ ä»·æ ¼æ›´æ–°å·¥å…·æ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateToolbar(bars) {
      if (!bars || bars.length < 2) return;
      const last = bars[bars.length - 1];
      const first = bars[0];
      const change = last.close - first.open;
      const changePct = (change / first.open * 100).toFixed(2);
      const priceEl = document.getElementById("price-label");
      const changeEl = document.getElementById("price-change");
      priceEl.textContent = last.close.toFixed(2);
      changeEl.textContent = `${change >= 0 ? "+" : ""}${change.toFixed(2)} (${changePct}%)`;
      const cls = change >= 0 ? "up" : "down";
      const clsBg = change >= 0 ? "up-bg" : "down-bg";
      priceEl.className = cls;
      changeEl.className = `${cls} ${clsBg}`;
    }

    // SuperTrend æŒ‰æ–¹å‘æ®µåˆ›å»ºç‹¬ç«‹ LineSeriesï¼Œåˆ‡æ¢ç‚¹è‡ªç„¶æ–­å¼€
    function createSegmentedST(bars) {
      // æ¸…é™¤æ—§ series
      stSeriesList.forEach(s => chart.removeSeries(s));
      stSeriesList = [];
      stLastDir = null;

      let currentDir = null;
      let segData = [];

      function flushSegment() {
        if (segData.length === 0) return;
        const color = currentDir === 1 ? '#26a69a' : '#ef5350';
        const s = chart.addLineSeries({
          color,
          lineWidth: 2,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
          priceLineVisible: false,
        });
        s.setData(segData);
        stSeriesList.push(s);
      }

      for (const bar of bars) {
        if (bar.st_value === null || bar.st_dir === null) continue;
        if (bar.st_dir !== currentDir) {
          flushSegment();
          currentDir = bar.st_dir;
          segData = [];
        }
        segData.push({ time: bar.time, value: bar.st_value });
      }
      flushSegment();  // æœ€åä¸€æ®µ
      stLastDir = currentDir;
    }

    // â”€â”€â”€ åŠ è½½æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData() {
      try {
        const res = await fetch(`/api/data/${SYMBOL}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }
        const { symbol, m1_bars, position } = await res.json();

        document.getElementById("symbol-label").textContent = symbol;
        document.getElementById("loading").style.display = "none";

        // Kçº¿
        const ohlcData = m1_bars.map(b => ({
          time: b.time, open: b.open, high: b.high, low: b.low, close: b.close
        }));
        candleSeries.setData(ohlcData);

        // SuperTrend æŒ‰æ®µæ–­å¼€
        createSegmentedST(m1_bars);

        // å¼€ç›˜åŒºé—´ï¼ˆå‰15åˆ†é’Ÿ OR High / OR Lowï¼‰
        addOpeningRange(m1_bars);

        // ä»“ä½çº¿
        addPositionLines(position);

        // å·¥å…·æ ä»·æ ¼
        updateToolbar(m1_bars);

        // å­˜å‚¨å…¨å±€æ•°æ®ä¸æœ€æ–° ST
        currentBars = m1_bars;
        latestClose = m1_bars[m1_bars.length - 1]?.close;
        const lastST = [...m1_bars].reverse().find(
          b => b.st_value != null && b.st_value !== 0 && b.st_dir != null
        );
        if (lastST) { latestST = lastST.st_value; latestSTDir = lastST.st_dir; }

        // è·³åˆ°æœ€æ–°æ•°æ®
        chart.timeScale().scrollToRealTime();

      } catch (e) {
        document.getElementById("loading").textContent = `âŒ ${e.message}`;
        console.error(e);
      }
    }

    // â”€â”€â”€ åå­—çº¿ OHLC æ‚¬æµ®ä¿¡æ¯ï¼ˆTradingView é£æ ¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ciBox = document.getElementById('crosshair-info');
    const ciTime = document.getElementById('ci-time');
    const ciO = document.getElementById('ci-o');
    const ciH = document.getElementById('ci-h');
    const ciL = document.getElementById('ci-l');
    const ciC = document.getElementById('ci-c');

    chart.subscribeCrosshairMove(param => {
      if (!param || !param.time || !param.seriesData || !param.seriesData.size) {
        ciBox.style.display = 'none';
        return;
      }
      const bar = param.seriesData.get(candleSeries);
      if (!bar) { ciBox.style.display = 'none'; return; }

      // fake-UTC å­˜å‚¨ï¼šç›´æ¥è¯» getUTCHours å³ä¸º ET æœ¬åœ°æ—¶é—´
      const d = new Date(param.time * 1000);
      const hh = String(d.getUTCHours()).padStart(2, '0');
      const mm = String(d.getUTCMinutes()).padStart(2, '0');
      ciTime.textContent = `${hh}:${mm} ET`;

      const fmt = v => v.toFixed(2);
      const bull = bar.close >= bar.open;
      ciO.textContent = fmt(bar.open);
      ciH.textContent = fmt(bar.high);
      ciL.textContent = fmt(bar.low);
      ciC.textContent = fmt(bar.close);
      ciC.style.color = bull ? '#26a69a' : '#ef5350';
      ciO.style.color = bull ? '#26a69a' : '#ef5350';

      ciBox.style.display = 'flex';
    });

    // â”€â”€â”€ WebSocket å®æ—¶æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastTickTime = 0;  // è®°å½•æœ€è¿‘ä¸€æ¬¡ tick çš„æ—¶é—´æˆ³ï¼Œé˜²æ­¢ kline:1m: æ—¶é—´å›é€€
    function connectWS() {
      const ws = new WebSocket(`ws://localhost:3000`);
      ws.onmessage = ({ data }) => {
        try {
          const { channel, data: payload } = JSON.parse(data);

          // â”€â”€ Symbol è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰æ ‡çš„çš„æ¶ˆæ¯ï¼Œå…¶ä»– symbol çš„ tick/kline ç›´æ¥ä¸¢å¼ƒ â”€â”€
          // server ä¼šå¹¿æ’­æ‰€æœ‰ 4 ä¸ª symbol çš„æ¶ˆæ¯ï¼Œä¸è¿‡æ»¤ä¼šå¯¼è‡´æ—¶é—´æˆ³æ··ä¹±
          if (!channel.endsWith(`:${SYMBOL}`)) return;

          // K çº¿ tick å®æ—¶æ¨é€ï¼ˆæ›´æ–°å½“å‰æœªå®Œæˆ K çº¿ï¼‰
          if (channel.startsWith("bars:1m:tick:")) {
            lastTickTime = payload.time;
            candleSeries.update({
              time: payload.time, open: payload.open,
              high: payload.high, low: payload.low, close: payload.close,
            });
            latestClose = payload.close;
            return;
          }

          // K çº¿æ”¶ç›˜ï¼ˆkline:1m:ï¼‰â€”â€”ç«æ€é˜²æŠ¤ï¼štick å·²æ¨è¿›ä¸‹ä¸€åˆ†é’Ÿåˆ™è·³è¿‡ candleSeries.update
          if (channel.startsWith("kline:1m:")) {
            if (payload.time >= lastTickTime) {
              candleSeries.update({
                time: payload.time, open: payload.open,
                high: payload.high, low: payload.low, close: payload.close,
              });
            }
            latestClose = payload.close;
            const priceEl = document.getElementById("price-label");
            if (priceEl) priceEl.textContent = payload.close.toFixed(2);
            if (payload.st_value != null && payload.st_value !== 0) {
              latestST = payload.st_value;
              latestSTDir = payload.st_dir;
              if (payload.st_dir !== stLastDir || stLastSeries === null) {
                const color = payload.st_dir === 1 ? '#26a69a' : '#ef5350';
                stLastSeries = chart.addLineSeries({
                  color, lineWidth: 2,
                  crosshairMarkerVisible: false, lastValueVisible: false, priceLineVisible: false,
                });
                stSeriesList.push(stLastSeries);
                stLastDir = payload.st_dir;
              }
              stLastSeries.update({ time: payload.time, value: payload.st_value });
            }
            // è¡Œæƒ…å˜åŠ¨æ—¶åŒæ­¥åˆ·æ–°ä»“ä½æµ®ç›ˆ
            if (currentPosition && payload.symbol === SYMBOL) {
              currentPosition.unrealized_pnl =
                (latestClose - (currentPosition.avg_px_open ?? currentPosition.entry_price)) *
                currentPosition.quantity *
                (currentPosition.side === 'SHORT' ? -1 : 1);
              refreshPositionPanel(currentPosition);
            }
          }

          // â”€â”€ çœŸå® IBKR ä»“ä½å®æ—¶æ¨é€ï¼ˆstrategy.py æˆäº¤/å¹³ä»“æ—¶ PUBLISHï¼‰â”€â”€
          if (channel === 'position:update') {
            const pos = payload;
            // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰å±•ç¤ºçš„æ ‡çš„
            if (pos.symbol !== SYMBOL) return;
            if (pos.closed) {
              // å¹³ä»“ï¼šæ¸…ç©ºé¢æ¿
              clearPositionUI();
            } else {
              // å»ºä»“/åŠ ä»“/æµ®ç›ˆæ›´æ–°ï¼šé‡ç»˜ä»“ä½çº¿ + é¢æ¿
              // æ³¨æ„ï¼šé‡ç»˜å‰å…ˆé‡ç½®å›¾è¡¨ markersï¼ˆé¿å…å åŠ ï¼‰
              candleSeries.setMarkers([]);
              addPositionLines(pos);
            }
          }
        } catch (err) {
          console.error('[WSå¤„ç†é”™è¯¯]', err.message, err);
        }
      };
      ws.onclose = () => setTimeout(connectWS, 3000);
    }

    // â”€â”€â”€ æ­¢æŸçº¿æ‹–åŠ¨å¼€ä»“ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const slHandle = document.getElementById('sl-handle');
    const slPriceVal = document.getElementById('sl-price-val');
    const dragCapture = document.getElementById('drag-capture');
    const orderPanel = document.getElementById('order-panel');
    const opSlInput = document.getElementById('op-sl-input');
    const opConfirmBtn = document.getElementById('op-confirm');
    const opDirBadge = document.getElementById('op-dir-badge');
    const opTitle = document.getElementById('op-title');
    const opQtyDisplay = document.getElementById('op-qty-display');
    const opRiskPerShare = document.getElementById('op-risk-per-share');
    const opCost = document.getElementById('op-cost');
    const opCapitalHint = document.getElementById('op-capital-hint');
    const opMaxLoss = document.getElementById('op-max-loss');

    // æ ¸å¿ƒè®¡ç®—ï¼šæ ¹æ®æ­¢æŸä»·ä¸å½“å‰ä»·è‡ªåŠ¨åˆ¤æ–¹å‘ï¼ŒæŒ‰æœ€å¤§äºæŸç®—è‚¡æ•°
    // è´¦æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆè¿›å…¥å¼€ä»“æ¨¡å¼æ—¶å¼‚æ­¥è·å–ï¼‰
    let accountInfo = { total_equity: 0, available_cash: 0, engine_online: false };

    function recalcOrder() {
      const entry = latestClose || 0;
      if (!slPrice || !entry) return;

      // æ–¹å‘åˆ¤æ–­ï¼šæ­¢æŸåœ¨å½“å‰ä»·ä¸‹æ–¹ = åšå¤šï¼Œä¸Šæ–¹ = åšç©º
      const isBuy = slPrice < entry;
      orderDir = isBuy ? 'BUY' : 'SELL';

      // æ›´æ–°æ–¹å‘ badge å’Œç¡®è®¤æŒ‰é’®
      opDirBadge.className = `op-dir-badge ${isBuy ? 'buy' : 'sell'}`;
      opDirBadge.textContent = isBuy ? 'â–² åšå¤š' : 'â–¼ åšç©º';
      opTitle.textContent = isBuy ? 'åšå¤šå¼€ä»“' : 'åšç©ºå¼€ä»“';
      opConfirmBtn.className = `op-btn confirm ${isBuy ? '' : 'sell'}`;
      opConfirmBtn.textContent = isBuy ? 'ç¡®è®¤åšå¤š' : 'ç¡®è®¤åšç©º';

      // æ¯è‚¡é£é™© & æ­¢æŸ%
      const riskPerShare = Math.abs(entry - slPrice);
      const slPct = entry > 0 ? (riskPerShare / entry * 100) : 0;
      opRiskPerShare.textContent = riskPerShare > 0 ? `$${riskPerShare.toFixed(2)}` : 'â€”';
      opRiskPerShare.style.color = '#ef5350';
      const opSlPctEl = document.getElementById('op-sl-pct');
      opSlPctEl.textContent = slPct > 0 ? `${slPct.toFixed(2)}%` : 'â€”';
      opSlPctEl.style.color = '#ef5350';

      // â”€â”€ è‚¡æ•°è®¡ç®—ï¼ˆå– æœ€å¤§äºæŸ å’Œ èµ„é‡‘ä¸Šé™ ä¸¤è€…è¾ƒå°å€¤ï¼‰â”€â”€
      const maxLoss = parseFloat(opMaxLoss.value) || 100;
      const available = accountInfo.available_cash || 0;
      const total = accountInfo.total_equity || 0;
      // å¯ç”¨èµ„é‡‘ä¸Šé™ï¼š90% å¯ç”¨èµ„é‡‘ vs 100% æ€»èµ„äº§ï¼Œå–è¾ƒå°å€¼
      const cashCap = available > 0 ? Math.min(available * 0.9, total) : Infinity;
      const qtyByLoss = riskPerShare > 0 ? Math.floor(maxLoss / riskPerShare) : 0;
      const qtyByCash = cashCap < Infinity && entry > 0 ? Math.floor(cashCap / entry) : Infinity;
      const qty = Math.min(qtyByLoss, qtyByCash);
      opQtyDisplay.textContent = qty > 0 ? `${qty} è‚¡` : 'â€”';
      opQtyDisplay.style.color = qty > 0 ? '#d1d4dc' : '#787b86';
      if (qty > 0 && qtyByCash < qtyByLoss) {
        opQtyDisplay.title = `æŒ‰æ­¢æŸå¯å¼€ ${qtyByLoss} è‚¡ï¼Œå› èµ„é‡‘ä¸Šé™æŠ“åˆ° ${qty} è‚¡`;
      } else {
        opQtyDisplay.title = '';
      }

      // å¼€ä»“é‡‘é¢ & èµ„é‡‘å æ¯”
      const cost = qty * entry;
      opCost.textContent = qty > 0 ? `$${cost.toFixed(0)}` : 'â€”';
      const displayTotal = total > 0 ? total : null;
      if (qty > 0 && displayTotal) {
        const pct = cost / displayTotal * 100;
        opCapitalHint.textContent = `ğŸ’¡ å ç”¨ $${cost.toFixed(0)}  (è´¦æˆ·$${(displayTotal / 10000).toFixed(1)}ä¸‡çš„ ${pct.toFixed(1)}%)${accountInfo.engine_online === false ? '  âš  å¼•æ“é›¢çº¿' : ''}`;
      } else if (qty > 0) {
        opCapitalHint.textContent = `ğŸ’¡ å ç”¨ $${cost.toFixed(0)}  (å¼•æ“æœªè¿æ¥ï¼Œèµ„é‡‘æ ¡éªŒå·²è·³è¿‡)`;
      } else {
        opCapitalHint.textContent = 'è¯·å…ˆè®¾ç½®æ­¢æŸä»·';
      }
    }

    // æ›´æ–°æ‹–åŠ¨æŠŠæ‰‹çš„ Y åæ ‡ï¼ˆå•å…ƒç´ ç›´æ¥å®šä½ï¼‰
    // è·å– chartEl ç›¸å¯¹ chart-container çš„å¶å°” Y åç§»ï¼ˆç»Ÿä¸€åæ ‡ç³»ï¼‰
    const containerEl = document.getElementById('chart-container');
    function getChartOffset() {
      const cRect = containerEl.getBoundingClientRect();
      const eRect = chartEl.getBoundingClientRect();
      return eRect.top - cRect.top;  // chartEl åœ¨ container å†…çš„ å¼€å§‹ Y
    }

    // æ›´æ–°æ‹–åŠ¨æŠŠæ‰‹çš„ Y åæ ‡ï¼ˆå•å…ƒç´ ç›´æ¥å®šä½ï¼‰
    function updateHandlePosition() {
      if (!orderMode || slPrice === null) return;
      const y = candleSeries.priceToCoordinate(slPrice);  // ç›¸å¯¹ chartEl
      if (y === null) return;
      const offset = getChartOffset();
      slHandle.style.top = (y + offset) + 'px';  // è½¬æ¢ä¸ºç›¸å¯¹ chart-container
      slPriceVal.textContent = slPrice.toFixed(2);
    }

    // æ›´æ–° LWC priceLine å’Œé¢æ¿çš„æ­¢æŸå€¼
    // directY: æ‹–åŠ¨æ—¶ä¼ å…¥é¼ æ ‡ Yï¼Œç•¥è¿‡ priceToCoordinate å›ç®—ï¼Œé¿å…ç²¾åº¦æ§å±•
    function applySL(price, directY) {
      slPrice = parseFloat(price.toFixed(2));
      if (slPriceLine) {
        slPriceLine.applyOptions({
          price: slPrice,
          title: `æ­¢æŸ ${slPrice.toFixed(2)}`,
        });
      }
      opSlInput.value = slPrice.toFixed(2);
      slPriceVal.textContent = slPrice.toFixed(2);
      // æ‹–åŠ¨æ—¶ç›´æ¥ç”¨é¼ æ ‡ Y å®šä½ï¼Œåœæ­¢åå†ç”± priceToCoordinate æ ¡å¯¹
      if (directY !== undefined) {
        slHandle.style.top = directY + 'px';
      } else {
        updateHandlePosition();
      }
      recalcOrder();
    }

    // è¿›å…¥å¼€ä»“æ¨¡å¼
    async function enterOrderMode() {
      // å¼‚æ­¥è·å–çœŸå®è´¦æˆ·ä½™é¢
      try {
        const resp = await fetch('/api/account');
        const data = await resp.json();
        accountInfo = { ...data, engine_online: !data.engine_offline };
      } catch (e) {
        accountInfo = { total_equity: 0, available_cash: 0, engine_online: false };
      }

      // åˆå§‹æ­¢æŸä»·ï¼šä¼˜å…ˆç”¨ ST å€¼ï¼›å¦‚æ— åˆ™æŒ‰å½“å‰ä»· Â±1% ä½œä¸ºåˆå§‹å ä½
      // æ–¹å‘ä¼šåœ¨ recalcOrder() å†…ç”± SL ä¸å½“å‰ä»·çš„ä½ç½®å…³ç³»è‡ªåŠ¨åˆ¤å®š
      const initSL = latestST
        ? latestST
        : latestClose
          ? latestClose * 0.99   // é»˜è®¤å…ˆæ”¾åœ¨ä¸‹æ–¹ï¼ˆåšå¤šé¢„è®¾ï¼‰
          : 0;

      orderMode = true;

      // åˆ›å»º LWC æ­¢æŸä»·æ ¼çº¿
      slPriceLine = candleSeries.createPriceLine({
        price: initSL,
        color: '#ef5350',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: `æ­¢æŸ ${initSL.toFixed(2)}`,
      });

      // æ˜¾ç¤ºä¸€ä½“åŒ–æ§ä»¶
      slHandle.classList.add('active');
      orderPanel.classList.add('active');

      applySL(initSL);
    }

    // é€€å‡ºå¼€ä»“æ¨¡å¼
    function exitOrderMode() {
      orderMode = false;
      isDragging = false;
      if (slPriceLine) { candleSeries.removePriceLine(slPriceLine); slPriceLine = null; }
      slHandle.classList.remove('active');
      dragCapture.classList.remove('active');
      orderPanel.classList.remove('active');
    }

    // æ‹–åŠ¨å¼€å§‹
    slHandle.addEventListener('mousedown', e => {
      if (!orderMode) return;
      isDragging = true;
      document.body.style.cursor = 'ns-resize';  // å…¨å±€é¼ æ ‡æ”¹ä¸ºè°ƒæ•´å…‰æ ‡
      dragCapture.classList.add('active');
      e.preventDefault();
    });

    // æ‹–åŠ¨ç§»åŠ¨ï¼šé¼ æ ‡ Y æ˜¯ç›¸å¯¹é¡µé¢çš„ï¼Œéœ€è¦è½¬æ¢ä¸ºç›¸å¯¹ chart-container çš„ Y
    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const cRect = containerEl.getBoundingClientRect();
      const containerY = e.clientY - cRect.top;     // ç›¸å¯¹ chart-container
      const eRect = chartEl.getBoundingClientRect();
      const chartY = e.clientY - eRect.top;          // ç›¸å¯¹ chartElï¼ˆç”¨äº coordinateToPriceï¼‰
      const price = candleSeries.coordinateToPrice(chartY);
      if (price === null) return;
      applySL(price, containerY);  // æ‹–åŠ¨å¤§å°ç›´æ¥ç”¨ container Yï¼Œä¸åšå›ç®—
    });

    // æ‹–åŠ¨ç»“æŸï¼šç”¨ priceToCoordinate åšä¸€æ¬¡ç²¾ç¡®æ ¡å¯¹å¯¹é½æ­¢æŸçº¿
    document.addEventListener('mouseup', () => {
      if (!isDragging) return;
      isDragging = false;
      document.body.style.cursor = '';
      dragCapture.classList.remove('active');
      updateHandlePosition();  // ç²¾ç¡®å›ç®—ä¸€æ¬¡ï¼Œç¡®ä¿æ§ä»¶ä¸æ­¢æŸçº¿å¯¹é½
    });

    // æ­¢æŸä»·åªèƒ½é€šè¿‡æ‹–åŠ¨æ§ä»¶è°ƒæ•´ï¼Œä¸å¼€æ”¾é”®ç›˜è¾“å…¥

    // â”€â”€ æœ€å¤§äºæŸå˜åŒ– â†’ é‡æ–°è®¡ç®—è‚¡æ•° â”€â”€
    opMaxLoss.addEventListener('input', recalcOrder);

    // å›¾è¡¨æ‹–åŠ¨ç¼©æ”¾åé‡ç½®æŠŠæ‰‹ä½ç½®
    chart.timeScale().subscribeVisibleLogicalRangeChange(() => updateHandlePosition());
    chart.priceScale('right').applyOptions({});

    // â”€â”€â”€ ä»“ä½æ“ä½œæŒ‰é’®é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const openModal = document.getElementById('open-modal');

    // å¼€ä»“æŒ‰é’® â†’ è¿›å…¥æ­¢æŸæ‹–åŠ¨å¼€ä»“æ¨¡å¼
    document.getElementById('btn-open').addEventListener('click', () => {
      enterOrderMode();
    });

    // å–æ¶ˆï¼ˆorder-panel å†…çš„å–æ¶ˆæŒ‰é’®ï¼‰
    document.getElementById('op-cancel').addEventListener('click', () => {
      exitOrderMode();
    });

    // ç¡®è®¤å¼€ä»“ â€”â€” å®é™…è°ƒç”¨å¼•æ“ API
    document.getElementById('op-confirm').addEventListener('click', async () => {
      const sl = parseFloat(opSlInput.value);
      const entry = latestClose || 0;
      const maxLoss = parseFloat(opMaxLoss.value) || 100;
      const riskPerShare = Math.abs(entry - sl);

      // èµ„é‡‘ä¸Šé™æ ¡éªŒ
      const available = accountInfo.available_cash || 0;
      const total = accountInfo.total_equity || 0;
      const cashCap = available > 0 ? Math.min(available * 0.9, total) : Infinity;
      const qtyByLoss = riskPerShare > 0 ? Math.floor(maxLoss / riskPerShare) : 0;
      const qtyByCash = cashCap < Infinity && entry > 0 ? Math.floor(cashCap / entry) : Infinity;
      const qty = Math.min(qtyByLoss, qtyByCash);

      if (isNaN(sl) || sl <= 0 || qty <= 0) {
        alert('æ­¢æŸä»·æ— æ•ˆæˆ–é£é™©/è‚¡è¿‡å°ï¼Œæ— æ³•è®¡ç®—æœ‰æ•ˆè‚¡æ•°');
        return;
      }

      const costTotal = qty * entry;
      const confirmed = confirm(
        `ç¡®è®¤å¼€ä»“ï¼Ÿ\n` +
        `æ–¹å‘: ${orderDir === 'BUY' ? 'â–² åšå¤š' : 'â–¼ åšç©º'}\n` +
        `æ ‡çš„: ${SYMBOL}  æ•°é‡: ${qty} è‚¡\n` +
        `å¼€ä»“: å¸‚ä»· (~$${entry.toFixed(2)})\n` +
        `æ­¢æŸ: $${sl.toFixed(2)}  (æ¯è‚¡é£é™© $${riskPerShare.toFixed(2)})\n` +
        `é¢„è®¡èµ„é‡‘: $${costTotal.toFixed(0)}`
      );
      if (!confirmed) return;

      try {
        const resp = await fetch(`/api/order/${SYMBOL}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ side: orderDir, qty, stop_loss: sl, order_type: 'BRACKET' }),
        });
        const result = await resp.json();
        if (result.engine_offline || result.error) {
          alert(`âš  å¼•æ“æœªè¿æ¥æˆ–å‡ºé”™: ${result.error || 'è¯·å¯åŠ¨å¼•æ“'}
è¯·æ£€æŸ¥ main.py æ˜¯å¦å·²å¯åŠ¨`);
        } else {
          alert(`âœ… å¼€ä»“è¯·æ±‚å·²å‘å°åˆ°å¼•æ“
${SYMBOL} ${orderDir === 'BUY' ? 'åšå¤š' : 'åšç©º'} x${qty}
æ­¢æŸ: $${sl.toFixed(2)}`);
        }
      } catch (e) {
        alert(`ç½‘ç»œé”™è¯¯: ${e.message}`);
      }

      exitOrderMode();
    });

    // å¹³ä»“æŒ‰é’®
    document.getElementById('btn-close').addEventListener('click', async () => {
      if (!confirm('ç¡®è®¤å¹³ä»“ï¼Ÿ')) return;
      await fetch(`/api/position/${SYMBOL}`, { method: 'DELETE' });
      location.reload();
    });

    // ST è·Ÿè¸ªæ­¢ç›ˆ toggle
    let stTrailEnabled = false;
    document.getElementById('st-trail-toggle').addEventListener('change', async e => {
      stTrailEnabled = e.target.checked;
      await fetch(`/api/settings/${SYMBOL}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ st_trail: stTrailEnabled }),
      });
      const lbl = document.getElementById('st-trail-label');
      lbl.style.color = stTrailEnabled ? '#26a69a' : '#787b86';
    });

    // â”€â”€â”€ æ ‡çš„åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const symbolSelect = document.getElementById('symbol-select');
    symbolSelect.value = SYMBOL;
    symbolSelect.addEventListener('change', () => {
      window.location.href = `/?symbol=${symbolSelect.value}`;
    });

    // å¯åŠ¨
    loadData();
    connectWS();
  </script>
</body>

</html>